{"path":"lit/lit_sources/Seger23StorageDegradationModel.pdf","text":"HAL Id: hal-03927728 https://hal.science/hal-03927728 Submitted on 6 Jan 2023 HAL is a multi-disciplinary open access archive for the deposit and dissemination of sci- entific research documents, whether they are pub- lished or not. The documents may come from teaching and research institutions in France or abroad, or from public or private research centers. L’archive ouverte pluridisciplinaire HAL, est destinée au dépôt et à la diffusion de documents scientifiques de niveau recherche, publiés ou non, émanant des établissements d’enseignement et de recherche français ou étrangers, des laboratoires publics ou privés. A storage degradation model of Li-ion batteries to integrate ageing effects in the optimal management and design of an isolated microgrid Pedro V.H. Seger, Rémy Rigo-Mariani, Pierre-Xavier Thivel, Delphine Riu To cite this version: Pedro V.H. Seger, Rémy Rigo-Mariani, Pierre-Xavier Thivel, Delphine Riu. A storage degradation model of Li-ion batteries to integrate ageing effects in the optimal management and design of an isolated microgrid. Applied Energy, 2023, 333, pp.120584. ￿10.1016/j.apenergy.2022.120584￿. ￿hal- 03927728￿ P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 1 of 22 A Storage Degradation Model of Li-ion Batteries to Integrate Ageing Effects in the Optimal Management and Design of an Isolated Microgrid Pedro V. H. Seger¹, Rémy Rigo-Mariani¹, Pierre-Xavier Thivel², Delphine Riu¹ ¹ Université Grenoble Alpes, CNRS, Grenoble INP, G2Elab, F-38000 Grenoble, France. ² Université Grenoble Alpes, Université Savoie Mont Blanc, CNRS, Grenoble INP, LEPMI, F-38000 Grenoble, France. ARTICLE INFO ABSTRACT Keywords: Battery Degradation, Energy Management Strategy, Microgrid Design, Dynamic Programming Li-ion batteries are being increasingly used in stationary applications, allowing for greater autonomy and facilitating the integration of renewable energies. However, these devices lose their capacity over time, especially during their so-called second life. This degradation affects the operation of the system and its cost, and must be taken into consideration if an optimal management is to be found. In this work, we present a framework for the integration of the battery aging in a microgrid design and energy management problem. To do so, we first propose a method to simplify a reference model for cyclic degradation of batteries. The results show that the battery loss of capacity shall be compute on a weekly to monthly basis to accurately keep track of degradation effects. Also, at a first order, we show that ageing is dependent with the initial battery State of Health at every update and the energy exchanged normalized by the nominal capacity. This simplified model formulated with Mixed Integer Linear Programming is integrated in a management problem of an isolated energy system for cost minimization. Optimization results show the necessary trade-off between storage degradation and overall system performances. Finally, a tailored dynamic programming is proposed to simulate successive years for the optimal sizing of the considered system in terms of battery capacity and its replacements. Compared to the proposed approach, not accounting for the storage degradation leads to inaccurate results and significant cost underestimations (> 20%). 1. Introduction The transition towards future energy systems requires a reduction in the consumption and use of fossil fuels, as well as an increased deployment of Renewable Energy Sources (or RES). A recent study from the IEA predicts that more than 80 percent of people gaining access to electricity by 2030 will be partly or entirely supplied by RES [1]. These sources are usually associated with storage devices, such as Li-ion Batteries (LIBs), to alleviate the generation intermittence and increase the systems controllability and flexibility. Furthermore, the recent growth of the Electric Vehicle (EV) market is responsible for a steadily increase in the demand of LIBs, with an estimated demand of hundreds of GWh in the years to come [2]. These EV batteries can be reused in less critical applications once they lose a certain amount of their capacity: the so-called Second Life Batteries (SLBs) – typically 20 % loss of nominal capacity. Therefore, the further deployment of LIBs in stationary applications is a certainty, which brings new technologic and scientific challenges. Extensive work has been done in the modelling of batteries and their ageing [3]–[9]. However, most works concentrate on characterizing LIBs in well-known conditions, such as repetitive charging profiles under constant current. Studies have shown that battery life vary significantly under different cycling conditions [10]. Their inclusion in real systems entails new challenges, notably concerning the uncertain utilisation of the battery and the integration of its ageing into an optimisation problem. Especially, finding the optimal size, operation and number of battery replacements required can quickly become a complex task with nonlinear degradation models, even more so considering the context of distributed generation [11]. Some recent works have been developed towards the integration of battery degradation in an Energy Management System (EMS) and will be mentioned in the following paragraphs. A first possibility is to consider an ageing model as a tool of analysis, decoupled from the system operation. This approach generally consists of (i) finding an economically optimal operation of the system P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 2 of 22 over a period of time, (ii) estimating the battery ageing over this period and (iii) repeating the process until the end of life of the batteries. Such an approach is used in [12] to calculate the break-even cost for SLBs. In [13], the most cost-effective storage system size is found for several categories of residential consumers. The need of several battery replacements under certain system planning conditions is shown in [14]. The level of ageing modelling and its impact on lifetime estimations is studied in [15]. This type of hindsight approach has the advantage of allowing the use of more accurate models and giving a notion of the technical-economic performance of a solution. However, there is a clear limitation in that these factors are not taken into account at the time of the decision (e.g. optimisation). Integrating ageing into an EMS means including one or more equations in the optimisation problem (e.g. in the form of a constraint) with the aim of limiting battery degradation. However, doing so is not an easy task, mainly because of two limitations: (i) detailed ageing models are often highly non-linear and/or non- convex, due to the need of considering several stress factors that affect battery degradation; (ii) for cycling ageing, identifying the main stressors (such as the cycle depth and the average State of Charge (SoC)) requires cycle counting algorithms (such as the Rainflow algorithm [16]) over a given period of time, who often do not have a closed form, making its integration into an optimisation problem difficult. To circumvent these difficulties, several authors have proposed solutions with different levels of complexity. A first very simple solution is to consider constraints that are known to limit battery ageing, but that do not constitute an ageing model per see - for example, limiting the battery SoC boundary values [12], the maximum power [17] or the number of cycles in a time period [17], [18]. Another approach is to concentrate on simplifying the classification of cycles: some authors consider discrete depth of discharge intervals and the notion of cycles to failure to estimate the battery life [19], [20], whereas other works propose simplified versions of the Rainflow algorithm [21], [22]. These approaches are often limited in the sense that the only battery stress factor considered is the depth of discharge. Moving towards more complete solutions, we can mention those that use the notion of energy exchanged by the storage [23]. This consists of using data from battery manufacturers to find the amount of complete equivalent cycles for certain conditions. Equations are then added to limit this energy: this is part of the objective in [24], whereas in [25] it is a constraint. In [26], the authors consider the battery as an exchangeable energy reservoir to impose a constraint on the number of equivalent cycles performed during the project. This type of solution is easy to implement, as the exchanged energy is easily calculated by the optimisation problem. However, it is limited in the sense that the number of equivalent cycles achievable by the battery does not only depend on the energy exchanged, but on the way this energy is exchanged [27] (e.g. rate of charge/discharge and depth of cycles). To circumvent this, some authors use the notion of weighted exchanged energy, by adding penalties on certain conditions, such as the current [28], [29] and the temperature [30]. Although more accurate, these approaches are limited in the consideration of the SoC profile. In [31], the authors only consider the minimum SoC for each MWh exchanged. In [32], the authors rely on a cycle definition based only on discharges and limit their analyses to short duration profiles, due to the lack of a finer cycle count. Another common characteristic of most of the above-mentioned papers is that the effect of battery ageing on other system components is often neglected - for example, the decrease in self-consumption as the battery capacity diminishes. Finally, other approaches have been used in recent works. In [33] and [34], a physics-based battery model is developed with a focus on the performance loss due to the degradation; however, the simulated ageing behaviour seems mostly linear. In [35], a cumulative degradation mathematical tool is proposed to constraint the battery ageing, but the focus remains on short-to-medium term system operation. Therefore, the objective of this work is to propose a novel method to integrate the notion of battery degradation into an optimisation problem, allowing for the appropriate sizing and energy management of the storage thanks to the long-term simulations (up to full 10 years). As a case study, we will consider an isolated microgrid to which we want to add solar panels and a second-life battery system. Note that the model P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 3 of 22 simplification proposed can be applicable to first-life batteries, provided data cycling data are available to establish the reference equations ([27]) The main contributions of this paper are: ▪ A novel battery degradation model derived from the non-linear model presented in [27]. Results show that the battery loss of capacity shall be computed on a weekly to monthly basis to accurately keep track of degradation effects. Ageing is dependent with the initial battery State of Health at every update and the energy exchanged normalized by the nominal capacity. ▪ The integration of the model in a tailored EMS (relying on Mixed Integer Linear Programming) and associated with an adapted Dynamic Programming (DP) to compute optimal SoH trajectories over time for a given system. Increased costs obtained when considering the ageing effects validate the need for the proposed approach. ▪ The proposed approach is finally used to find the optimal sizing of the “PV-storage” duo in the studied isolated microgrid, as well as the number of storage replacements. Especially, results show that not accounting for the battery degradation can lead to inaccurate results and cost under estimation (> 20 %). The rest of the paper is organized as follows: Section 2 present the methodology for the ageing model simplification and its inclusion in the EMS. Section 3 presents the dynamic programming adapted to long-term optimal simulations. Section 4 present the obtained results of optimal sizing and energy management. Section 5 concludes this work and presents perspectives. Table 1: Nomenclature of the used symbols Sets : Parameters : tT Set of time steps within a month , l mtp Load at time t at month m (kW) mM Set of simulated months , pvN mtp Normalized solar generation (kW) kK Set of initial SoH intervals ,soc soc Lower/upper bound for the state of charge (%) Variables : 0soc Initial state of charge (%) , g mtp Genset generation at time t in month m (kW) s Battery efficiency (-) , , ,,, s s s m t m t m tp p e +− Battery charge/discharge and energy (kW, kWh) 00,kksoh soh Bounds for initial monthly SoH in block k (%) , pv mtp Solar curtailment at time t in month m (kW) k Slope for soh degradation in block k (%) exch me Normalized exchange energy at month m (-) 0soh Initial SoH (%) 0 msoh Initial state of health SoH at month m (%) soh Maximum allowable SoH degradation (%) msoh SoH variation at month m (%) esR, ppvR, pgR Battery, solar, genset capacities (kWh, kW, kW) ,mku Initial SoH at month m in block k {0,1} Ny System lifetime (years) csR, cpvR Storage/solar installation costs (€/kWh, €/kWp) 2. Ageing Model and Energy Management Strategy 2.1. Basic Management Equations and Motivations In the context of an optimal systemic ([36]) design that considers ageing effects of storage equipment, the first step is to implement an EMS that embeds a battery degradation model. This EMS can be furtherly integrated in a design loop in order to simulate the system operation over its lifetime and for different installed capacities, as discussed in the next section. Figure 1 gives the layout of the generic isolated microgrid considered in this study with a load supplied by a conventional generator associated with a solar/battery system. P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 4 of 22 Conventional EMS for such systems consists in supplying the load with the minimum amount of fuel cost (i.e. genset usage pm,t g at price π g) thanks to an appropriate battery operation (1). Note that the operating variables over the simulation horizon (e.g. several years) are here defined over successive months (index m) due to assumptions for the battery ageing model simplification (discussed in the next subsection). Typically, for given rated capacities of installed solar (ppvR) and storage (esR), the EMS lies on an optimization problem with the storage operating in charge (pm,t s+ ) and discharge (p m,t s- ) within its limits (2). The power limits are defined with regards to the storage capacity to ensure that the system does operate below 1 C-rate in order to avoid over ageing and ensure the conservativeness of the degradation model. A classical linear model of the battery updates the available energy em,t s at each time step (i.e. at time step t in month m) (3), which has to remain within bounds in terms of state of charge (SoC) level (4), and returns to its initial value at the end of the simulated period (cyclic constraint in (5)). Additional constraint (6) allows to connect successive months together in term of SoC profile to represent the operation over the entire time horizon (e.g. a year). The genset also operates within its limits (i.e. below the rated power in (7)) and the solar curtailment ∆pm,t pv is bounded by the available generation at every time step depending on a given normalized profile pm,t pvN (8). Finally, constraint (9) ensures that the overall power balance between generation (left hand side) and consumption (right hand side). A list of the main used symbols is given in Table 1. Figure 1: Generic hybrid isolated system with storage. ,: min gg mt m M t T obj p dt   (1) ,,0 , /1 s s sR m t m tp p e h −+ (2) , 1 , , ,/ s s s s s s m t m t m t m te e p p −+ + = − +  (3) , sR s sR mtsoc e e soc e    (4) 0 1, 1 || ||, || || s s sR m t m M t Te e e soc= = = == =  (5) 1, 1 , || || ss m t m t Tee+ = == (6) ,0 g gR mtpp (7) ,,0 pv pvR pvN m t m tp p p    (8) , , , , , , l s pv g s pvR pvN m t m t m t m t m t m tp p p p p p p +−+ +  = + +  (9) Such traditional EMS in the form of a linear programming problem can easily be solved while simulating long periods (e.g. several successive years). However, degradation models for Li-ion batteries usually cannot be explicitly formulated using Mathematical Language Programming similarly to the EMS. In ,,, ss m t m tpp −+ ,, pvR pvN pv m t m tp p p − , l mtp ,nte , g mtp P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 5 of 22 this study, we consider a second life battery cyclic ageing model, detailed in [27]. This model estimates the loss of battery capacity (Q loss, proportional to a decrease Δsoh of the State of Health) with an exponential term that depends on several coefficients (10). One of these coefficients (𝜎) is a variable term depending on the battery SoC profile over a given horizon Th (socth), more specifically on three factors: the cycle depth, the cycle average SoC and the current. This is done through a Rainflow cycle counting algorithm [16] which characterises the battery cycles over a time period. Overall, the loss of capacity depends indirectly on the profile socth and the initial state of health soh0 (10). It is highly non-linear with a non-trivial analytical expression. 𝑄𝑙𝑜𝑠𝑠 = 𝑎 𝑒𝜎𝑏𝜀𝑄𝑐 − 𝑐 ↔ Δ𝑠𝑜ℎ = 𝑓(𝑠𝑜𝑐𝑡ℎ, 𝑠𝑜ℎ0) (10) Preliminary tests consisted in handling this non-linear system in a blackbox fashion (i.e. global optimization), using Matlab fmincon and its interior-point algorithm [37]. We integrated a constraint on the battery degradation (e.g. Δsoh < 5%) over a simulated horizon in the EMS presented previously to solve the problem summarized in (11) – i.e. operational costs minimization subject to operating and ageing constraints. Different lengths for the times series profiles were investigated (i.e. simulation horizon) from three days to thirty successive days in a given month. As the results from the non-linear solver considered depends on the initial points, ten independent runs were performed for each simulation horizon with starting points taken randomly between the bounds of every variable. ( ) , 0 min (1) : with : {1} and varying (7-30 days at =1h) . . linear constraints : (2)-(9) non-linear constraint : , 5% gg mt m M t T th p dt M T dt st soh f soc soh     =   (11) The obtained results are displayed in Table 2 with the average computational time, objective values and number of function evaluations of the function. The solving time significantly increases with the considered time horizon, up to more than 10 minutes for a monthly simulation. Especially, for those formulations over thirty days, the maximum number of functions evaluation (set to 1.10e6) in each of the ten independents runs. A proper convergence of the algorithm would then require longer computational time. In addition, the discrepancies between the average and best objective values obtained after ten runs highlight the dependency of the optimization result with the starting point – in case of monthly simulation the average objective values almost double the best one observed. As already mentioned, in the context of optimal system design, longer simulation horizons (several years) shall be considered for different system configurations (in terms of installed capacities), before returning the best solutions. A highly nonlinear degradation model is then incompatible with such simulation requirements. This motivated this paper with the first objective to simplify (convexify here) the reference model that was developed in previous works and then move towards a proper ageing aware design strategy Table 2: Preliminary optimal management with a non-linear solver – results over ten independent runs Time Horizon 3 days 7 days 15 days 30 days Computational time (average) 18 s 90 s 225 s 750 s Objective value (average) 785 € 1,506 € 3,435 € 11,985 € Objective value (best) 785 € 1,257 € 2,926 € 6,568 € Number of function evaluation (average) 125 k 726 k 626 k > 1 M Maximum of iterations reached 0 % 60 % 20 % 100 % P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 6 of 22 . 2.2. Preliminary Tests for the Simplification of the Degradation Model As a first step to simplify the degradation model, we consider the outputs of an EMS run over a whole year (i.e. 12 months in the monthly set M) and for arbitrary equipment size: esR = 400 kWh, ppvR = 100 kWp and pgR = 120 kW. Those arbitrary values are chosen so that the solar panels display a capacity close to the peak load value for the considered load profile (corresponding to a village of around 150 families in North Africa). Also, with three peak sun hours on average per day, the storage shall be able to absorb totality of the daily production in case there is no load – the optimal sizing of the system is discussed in the last section of this paper. Remind that the objective of the paper is the reduction of the computational time for a system management strategy (i.e. optimal control) that is capable to account for the storage degradation effects. Ultimately this management over long periods of time shall be integrated in an optimal design strategy while investigating different system configurations. This will be investigated in the last results presented further in Section 4. More importantly, no constraint is considered at this stage for the battery degradation and the initial state of health soh0 is set to 78 % (assumed for a second life battery). The EMS returns the optimal state of charge profile over the time horizon (at one hour horizon here) along with the system operating costs. The idea here is to execute the Rainflow algorithm and the detailed ageing model over those SoC profiles in order to evaluate the degradation over time. As displayed on the flowchart in Figure 2, the degradation can then be estimated every Th period (e.g. every day, week or month) while considering the SoC profile over the corresponding time steps and soh0 at the start of the period. Figure 2: State of health degradation estimation over a yearly simulation. Figure 3 displays the results for various update periods Th. We observe that for large values of Th, such as six months or a year, the loss of capacity is underestimated compared to smaller update periods. This is due to the fact that the initial SoH value (soh0 ) is not adequately updated. Similarly, daily update of the state of health does not return a good estimation of the degradation. As previously, mentioned, the ageing depends on the number of cycles in the considered socth profiles. Updating the degradation too often tends to shorten the SoC profiles while potentially ‘cutting’ cycles, thus leading to an underestimation of the actual loss of capacity. Intermediate update periods (weekly, bi weekly and monthly) seem to return estimations that are more consistent. Those resolutions are then deemed a good trade-off to capture the impact of both storage cycling and the initial state of health update along the system lifetime. In the remaining of the paper, monthly stepwise Initialization soh0 =78 % t0= 1 th = [t0..Th] Extract state of charge profile socth Run ageing model Δsoh=f(socth , soh0) Th=Tend ? t0 = t0 + Th STOP return the soh profile over the successive updates yes no Update initial state of health soh0= soh0 ₋ Δsoh P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 7 of 22 computation of capacity loss (in terms of Sate of Health decrease Δsoh) will be considered and integrated in EMS, that can then optimize on successive months. Figure 3: State of health degradation over a year for different update periods Th at which the reference ageing model is run. In previous works (and similar to many research in the field of storage ageing), battery degradation was assessed with pre-defined SoC profiles, at a given C-rate, average values and depth of discharge [4], [5], [38]. In order to assess the loss of capacity under more realistic conditions, the EMS previously defined is used to generate various monthly SoC profiles under different conditions as follows: • 12 independent months for PV generation and load profiles. • 6 different storage capacities: e sR = [100 kWh, 200 kWh, …, 500 kWh, 600 kWh]. • 8 different solar capacities: p pvR = [100 kWp, 200 kWp, …, 700 kWp, 800 kWp]. • 5 different initial SoH values: soh0 = [80 %, 78 %, 75 %, 70 %, 65 %]. This yields 2880 possible combinations, each corresponding to a distinct SoC monthly profile. In every case, the resulting SoC monthly profile was passed through the degradation model in order to compute the loss Δsoh (for a given soh0). For every scenario, the EMS returns the charging/discharging profiles for the storage that are used to compute a metric em exch defined as the monthly exchanged energy normalized by the rated battery capacity as in (12). ( ),, ss m t m t exch tT m sR p p dt e e +−  + =  (12) Figure 4 displays the results for all generated monthly scenarios and for different initial state of health. Each point represents one of the 2880 possible combinations mentioned above, and the different colours separate the results by their soh0. The curves clearly highlight the impact of soh0, the greater the initial degradation, the greater the degradation for similar mission profiles – i.e. exponential term in the SoH calculation in (10). What is more noticeable is the correlation of the SoH with the normalized exchange energy over a month. Indeed, this metric implicitly embeds the number of cycles along with the depths of discharge – greater numbers of cycles with deep discharge obviously lead to more exchanged energy. Standard linear regressions display coefficients of determination over 0.98, which open the possibility for a simple convex representation of the degradation (over a month). Quadratic and piece wise linear regressions led to R2 greater than 0.99, however their implementation in the EMS is not explicated in this paper as preliminary results shows that they could led to longer computational times with no specific improvements compared to the linear formulation. Th = 1 year Th = 6 months Th = 1 dayTh = 2 weeks Th = 1 week Th =1 month 0 60 120 180 240 300 360 73 74 75 76 77 78 Nb. of days (-)SoH(%) Underestimation for long horizons due to non update of the initial SOH Underestimation for short horizons due to uncomplete cycles P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 8 of 22 Figure 4: Monthly loss of capacity Δsoh over 2880 scenarios for different soh0 values and exchanged energy (over a month), comparison and linear approximation. This allows us to conclude that our baseline ageing model can be simplified - for the intended uses in the system in question - in terms of two indicators that are easy to calculate by the optimisation problem: the normalized exchanged energy em exch and the initial SoH. Moreover, the relation between these two variables and the capacity loss can be considered as linear (see Figure 4). The results and validation of this simplification in comparison with the baseline model will be presented in Section 4. We believe that this novel modeling approach is superior to the widely used exchanged energy models, as it stems from extensive testing of a detailed non-linear model. Furthermore, the obtained set of linear regressions present an important advantage in the fact that it allows the emulation of the exponential nature of battery ageing. 2.3. MILP Formulation This subsection explicit the formulation of the simplified degradation model and its integration in the previously introduced EMS. The main idea is to take into account the normalized exchanged energy and the initial state of health on a monthly basis, while the EMS is run over successive months at an hourly basis here (i.e. set T). The mathematical formulation of Figure 4 relies on the 1D method to represent bi variate functions with the use of Mixed Integer Linear Programming (MILP) [39]. Especially, the proposed formulation requires the introduction of additional variables and constraints in the original EMS. At firs a set k ∈ K is defined to describe the potential intervals or blocks for the soh0 values (e.g. from 80 % to 78 %, from 78 % to 75 %, etc). Each interval is assigned with corresponding lower (sohk 0) and upper (sohk 0) bounds and a continuous variable sohm 0 representing the actual initial state of health at every month. A binary variable um,k is added in order to identify which interval corresponds to the monthly initial State of Health with constraint (13). Constraint (14) ensures that only a single interval is ‘active’ at every month. 0 0 0 ,, k k m m k k m k K k K soh u soh soh u      (13) , 1km kK u  = (14) A variable Δsohm is then defined to represent the capacity loss over month m that is computed depending on the ‘active’ interval with (15). The coefficient λ set to 100 % ensures the constraint is not active for any interval that does not correspond to the actual sohm 0 (‘BigM’ value), and αk represents the slope of the 0 10 20 30 40 50 60 0 1 2 3 4 5 6 7 soh0=65 % soh0=70 % soh0=75 % soh0=78 % soh0=80 %Δsoh(%)() exch me − monthly scenarios for different soh0 linear regression P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 9 of 22 linear regression in the k th block (cf. Figure 4). Once the capacity loss is known, the initial state of health can successively be updated over the months ((16)), starting at a given value soh0 at the beginning of the EMS simulation ((17)). ( ) ( ),,11 exch exch k m k m m k m k me u soh e u    −  −     +  − (15) 00 1m m msoh soh soh+ = −  (16) 00 1msoh soh= = (17) Finally, it is important to remind that the overall objective of the ageing model is to account for the loss of capacity. Thus, at every month the storage capabilities in power ((18)) and energy ((19)) shall be updated with regards to the loss of capacity resulting from the battery usage at the previous month, with regards to the rated energy esR. Note that the operation at a maximum of 1 C-rate of the battery is ensured not matter its actual capacity in kWh. The formulation given thus far embeds the estimation of the state of health. In order to assess the impact of any limit of the ageing on the system performances (i.e. operating cost here), an additional constraint with a maximum degradation ∆soh can be introduced as in (20). ( ) 0 ,,0 , /1 s s sR m t m t mp p e h soh −+   (18) 00 , sR s sR m m t msoc e soh e soc e soh      (19) 0 m mM soh soh soh  −    (20) The equations presented in this subsection allow us to calculate and constrain ageing in the short-term optimisation problem (EMS). However, we lack a tool to insert these notions into a long-term system design problem. The development of such a tool, as well as initial EMS results, will be shown in the next section. 3. Long Term Management and Optimal SoH Trajectories 3.1. Motivations In the context of optimal design, the management strategy must be run over longer periods of time (system lifespan of ten years assumed here) and for different configurations in terms of installed capacities. Preliminary tests consisted in running the EMS previously introduced over ten years with given capacities of solar (p pvR = 100 kWp) and storage (esR = 400 kWh) and a fixed generation cost for the genset π g = 0.78 €/kWh - i.e. 120 months at an hourly time step within a single optimization problem. This proved impossible to solve due to insufficient memory and the computational capabilities. Thus, for scalability/feasibility purposes, successive yearly simulations (i.e. yearly optimization) are considered instead to account for long term horizons. As for example, Figure 5a displays the results obtained when operating the battery over successive years with no constraints on its loss of capacity over the months apart from a minimum SoH value set to 60 %. Remind that the physical degrees of freedom of the system are the battery charge/discharge and solar generation curtailment. However, state variables (e.g. energy within the battery, the monthly soh, the exchange energy, etc) are part of the optimization and their values can then be retrieved once the optimal management is computed. Both SoH profiles and exchanged energy can then be displayed on a monthly basis. In Figure 5a the storage reaches this lower limit after five years, with a limited battery usage in the last year compared to the previous ones due to the minimum capacity constraints. A replacement can then occurs at the end of the fifth year for a total operating cost of 656 k€ over ten years (excluding the replacement costs). P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 10 of 22 An alternative can consist in a control of the SoH degradation while adjusting the ∆soh limit over successive yearly optimizations, so that it reaches its end of life at the end of the ten years period – i.e. less than 2 % loss after one year, less than 4 % after two years, etc. Results displayed in Figure 5b shows similar battery usage as in the previous case over the first three years. However, after four years, the battery contribution is very limited in order to control its degradation and reach the minimum SoH value (60 %) at the end of the considered lifespan. This reduced battery usage leads to higher operating costs (750 k€) over ten years but no storage replacement is required. Note that in the results displayed, for the sake of simplicity, the system operations are not explicitly represented with typical power profiles (e.g. for the battery or the genset). Instead, the battery usage is somewhat summarized with the normalized exchanged energy (at a monthly resolution). All along the paper, the results analysis focuses mainly on the economic performances and storage degradation, rather than on power profiles. The two previous illustrative examples highlight the impact of the SoH values on the final operating costs - further illustration of this arbitrage are given in the next section. Thus, for given solar and storage capacities, the optimal management of the system may be regarded as problem of optimal SoH trajectory over the lifetime and while accounting for potential storage replacements. The need for replacements is especially important when considering second life batteries that degrades faster than first life assets. Figure 5: Monthly SoH profiles and normalized exchanged energy of the battery over 10 years (period : ten years, step size : one month) – a) no degradation constraints and a storage replacement whenever SoH reaches 60 % - b) degradation constraint over the system lifetime. In order to do this, we rely on the concept of Dynamic Programming (DP) [40], an approach to optimisation consisting in decomposing the optimisation problem into several sub-problems and solving them \"upwards\". This approach is commonly used in optimisation problems related to the planning of systems with energy storage, such as in [41], [42]. In our case, the proposed idea is to separate the SoH optimisation problem into discretised time periods, towards a calculation of the battery SoH trajectory between these periods. 3.2. Tailored Dynamic Programming Following the discussion of the previous subsection, the optimal management of the system along its lifetime is then discretized as successive yearly optimizations performed using the EMS presented in Section 0 12 24 36 48 60 72 84 96 108 120 0 7 14 21 28 month (-) 60 70 80 0 12 24 36 48 60 72 84 96 108 120 0 7 14 21 28 month (-) 60 70 80 () exch me −() exch me −soh(%)soh(%) 75 65 75 65 a) b) Storage exchanged energy (-) soh profile (%) opex = 750 k€ opex = 656 k€ + 1 storage replacement P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 11 of 22 2 (over 12 months). Especially, the SoH value at the end of each year can be controlled with the degradation constraint (20). Ultimately, the long-term management problem is defined a succession of states over several years from an initial condition x0 and with an oriented graph as displayed in Figure 6. Figure 6: Discretization of the long-term planning problem. Each state xi is then characterized by a year and by a SoH level at the end of the year. The SoH level follows a predefined discretization from 80 % (starting capacity for second life battery) down to 60 % (estimated end of life). The cost of the transition t(xi,xj) between two states xi and xj on two successive years is the operating costs computed with the previously introduced EMS and the appropriate degradation constraints – i.e. the yearly degradation shall not exceed the SoH difference between the values at state xi and the target value at state xj. . Obviously, no battery usage will not incur any degradation over the year, as calendar ageing is not reflected in the considered model. In addition, a case can occurs where the SoH conditions between two states may not be met: starting from a given SoH value (and for a given storage/solar capacities) it is not necessary to degrade or use the battery beyond a certain point to minimize the operating costs. In such case, the SoH at the end of the simulated year will never be below certain values for the considered SoH interval. The corresponding transition are then neglected (e.g. from 80 % to 70 %, 80 % to 65 %, etc in Figure 6). For the sake of simplicity and in order to limit computational times, all the successive years display the same solar generation and load profiles (at an hourly time step). Thus, for given solar/storage capacities, a preliminary step consists in identifying and computing the cost of all the possible transitions between two SoH values over one year (and adding a salvage value if needed). Once all the transition costs are known, Dynamic Programming and Bellman equations can be used to compute the optimal path from the initial state to the end states [40]. The cost 𝑐∗(𝑥𝑗) of a given state xj is computed as the optimal cost 𝑐∗(𝑥𝑖) of one of its predecessors xi plus the transition cost. The optimal cost of a state at year y is defined as the minimum cost computed over all its potential predecessors at year y₋1 (21). Once all the states costs are computed, the optimal path can be reconstructed backward from the end states with successive updates of the optimal predecessor states. This approach is valid as long as there is a single initial node and no circuit in the graph, which is the case here. ( ) ( ) ( )( ) ** predecessors c min c t ,j i i j i x x x x  =+ (21) year 1 year 2 year 3 80 % 75 % 70 % 65 % time discretization soh discretization xi xj t(xi, xj) unnecessary over degradation c(xj) = c*(xi)+t(xi, xj) x0 possible replacement when soh reaches 60 % P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 12 of 22 The pseudo code of the adapted Dynamic Programming is given in Table 3. Note that at the end of every year, a replacement of the storage can occur if it reaches a SoH of 60 % (double line arrows in Figure 6) – corresponding state xj. The SoH at the end of this year is then brought back to 80 % (state xk) if the replacement cost crep allows improving the optimal cost to reach xk (computed with no replacement). Table 3: Pseudo code of the adapted dynamic programming Algorithm for year y in 1 to N y: for all xj at year y: initialize c*(xj) = ∞ for all xi at year y₋1: if c*(xi)+t(xi, xj) < c*(xj) : c*(xj) ← c*(xi)+t(xi, xj) update optimal predecessor of xj if SoH at xj = 60 % - replacement opportunity xk = state with SoH at 80 % at year y if c*(xj)+crep < c*(xk) c*(xj) ← c*(xj)+t(xi, xj) update optimal predecessor of xk 3.3. Illustrative Tests A preliminary set of validation tests is run for illustrative purposes. As previously, solar and storage installed capacities are respectively fixed at 100 kWp and 400 kWh. The SoH space is discretized every 5 % from 80 % to 60 %. Figure 7a displays all the theoretical transitions from the initial node – i.e. the SoH at the beginning of the project lifetime (4 years here). While running different EMS with SoH degradation constraints, the set of possible transitions is reduced because strong degradation (e.g. from 80 % to 70 %) are not necessary for further operating cost reduction. All the possible transitions are highlighted in Figure 7b. Obviously the SoH cannot increase from one year to the other unless a replacement occurs (i.e. no ascending branch in Figure 7). Figure 7: Discretization of optimal SoH trajectory problem (period : four years, step size : one year) – a) all the theoretical transitions – b) all the feasible transitions for given solar/storage capacities. A first run of the proposed DP is then performed, and all feasible transitions are simulated - so the system knows the cost of moving from each SoH point to the next, at each simulated year. We can then use the proposed algorithm to find the ideal trajectory for this case study. In Figure 8, we compare the optimal trajectory proposed by the DP for two different values for battery replacement costs: 100 €/kWh (a) and 50 €/kWh (b). In the first case, the second life battery is not used for the first year and then depleted for the last three years, so that it reaches a SoH of 60 % at the end of the considered lifetime (Figure 8a). In the case of a reduced replacement cost of 50 €/kWh, the storage is used for the first three years to minimise operating costs and a replacement takes place at the beginning of the last year. 0 1 2 3 4 60 65 70 75 80 year (-)soh(%) 0 1 2 3 4 60 65 70 75 80 year (-)soh(%) P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 13 of 22 Indeed, the cost reduction from battery used in this final year offsets the replacement, with storage not reaching its minimum SoH at the end of the system lifetime (75 % here) (Figure 8b). The overall OPEX (including the replacement cost) is slightly smaller than the value obtained with a higher replacement cost. Figure 8: Optimal SoH path over four years (period : four years, step size : one year) – a) replacement cost at 100 €/kWh – b) replacement cost at 50 €/kWh Note that in the considered illustrative examples, the battery can reach its minimum SoH in three years only to reduce the OPEX as much as possible. It required five years in the preliminary tests for the same system configuration (Figure 5a). This difference is explained by the large SoH discretization considered here for illustrative purposes (5 %). For instance, when starting a year at a SoH of 80 %, the optimal use of the battery to reduce the OPEX leads to a SoH at around 78 %. However, the implemented dynamic programming accounts for an initial SoH at 75 % for the successive state, which incurs an artificial SoH loss. This imprecision can be mitigated while introducing a salvage value in case the SoH value in the discretized space is not perfectly reached by the optimal EMS. Instead, a smaller SoH discretization of 2 % will be considered in the results presented in the next section. Finally, also note that the accuracy of the algorithm in terms of optimality of the results can be increased with finer resolutions for the SoH level and time horizon. However, this would require computing greater numbers of transitions between states and increase the amount of potential combinations when reconstructing the optimal path. To avoid any computational burden, the temporal discretization of the states is set to a full year. However, each yearly interval is fully represented at one hour time step over twelve successive months while running the proposed management accounting for the storage degradation. 4. Obtained Results 4.1. Validation of the Simplified Degradation Model Over Yearly Simulations A first set of tests is performed to validate the formulation of the simplified degradation model reference estimation for second life batteries ([27]). Those simulations consist in running the EMS over a year for different values of initial State of Health soh0 and with no constraints on the total ageing over the year (constraint (20) inactive) – genset, solar and battery remain at the same arbitrary sizes as the one considered in the previous sections. As could be expected from the previous preliminary tests, the obtained SoH profiles along the successive months show greater degradations for lower initial soh0 values (Figure 9). More importantly the results how a good accuracy of the simplified model compared to the reference one with RMSE below 1 % of SoH, which validates the proposed simplification. It is also worth noticing that greater degradation occurs during the summer months where more surplus of solar generation needs to be managed (i.e. daily charges and discharge at night) 0 1 2 3 4 60 65 70 75 80 year (-)soh(%) 0 1 2 3 4 60 65 70 75 80 year (-)soh(%) b)a) opex : 281 k€ opex *: 278 k€ Optimal soh path *including replacement cost P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 14 of 22 Figure 9: Monthly SoH degradation over one year with different initial soh0 values, comparison between simplified and reference models (period : one year, step size : one month). The greater battery usage in summertime is confirmed by the results displayed in Figure 10 for the same set of simulations. The chart clearly highlights that more energy is exchanged (normalized by the nominal storage capacity here) between the battery and the system in summertime due to the need to store the surplus of solar generation. Intuitively, during winter times, reduces level of solar generation are directly self- consumed by the local load while any deficit is compensated by the genset. Note that the lesser the initial soh0, the lower the battery usage in terms of exchanged energy, due to reduced usable capacity. In other word, for an overaged battery, disadvantages are somewhat doubled as the degradation over a year is greater for even lesser usage, while the benefits (in term of operation) are also reduced compared to cases with higher soh0. Figure 10: Normalized energy exchanged monthly with different soh0 values (period : one year, step size : one month). 4.2. Trade-off between Storage Degradation and Operating Cost over Yearly Simulations The previous results highlighted the fact that overused batteries can lead to lesser economical gains. In this subsection, the EMS is run over a year for the same installed capacities as previously and for the same values of soh0. However, in every case, the constraint on the maximum yearly storage degradation is enabled with ∆soh varying from 1% to 10%. Results in Figure 11 confirmed that the yearly operating costs (OPEX with genset fuel costs) reduces with the battery initial state of health (soh0 = 80 %, 75 % or 70 % here). 0 2 4 6 8 10 12 55 60 65 70 75 80 Month (-)SoH(%) Baseline model Simplified model Increased cyclic degradation during summer 0 2 4 6 8 10 12 0 5 10 15 20 25 month (-) Lesser exchanged energy with smaller soh0 soh0 = 80 % soh0 = 75 % soh0 = 70 %() exch me − P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 15 of 22 More importantly, the trade-off between the OPEX and the allowable degradation is clearly highlighted for an initial soh0 = 70 % - we observe more than 15 % OPEX increase from a case with maximum degradation (i.e. 10 %) compared to a case with a minimum tolerance of 1 %. Note that for an initial state of health of 80 % the degradation limit over a year has barely not impact. Indeed, as displayed in Figure 9, in case of unlimited degradation, the actual estimated loss of capacity remains below 2 %. Thus setting ∆soh greater than 2 % does not show any impact on the OPEX. Figure 11: Trade off-between OPEX and maximum allowable degradation for different initial soh0 values From the previous set of simulations, three scenarios are isolated for an initial SoH of 75 % and for different values of allowed yearly degradation ∆soh – (A-3%, B-5% and C-10 % limit, see Figure 11). For each of those scenarios, the SoH profiles over the successive months are displayed on Figure 12. Results show that the limits on the final SoH values are fulfilled in scenarios A and B where the constraint is binding. For scenario C, the degradation limit is not reached, and the storage is operated optimally disregarding the ageing – i.e. similar results as observed in Figure 9 for soh0 = 75 %. Also, it is interesting to see that when the yearly degradation is limited, the EMS tends to delay the use of the battery before it is used in summertime. This illustrates well the impact and relevance of the integration of the ageing model in the management, which is ultimately translated into an economic loss or gain. Figure 12: SoH profile over a year for three distinct values of the ∆soh constraint (period : one year, step size : one month). 1 2 3 4 5 6 7 8 10 62 66 70 7 78 82 k€ (%)msoh 70 soh0=80 % soh0=75% A > 15 % OPEX increase 0 2 4 6 8 10 12 66 68 70 72 7 76 A C A : 3%msoh= B : 5%msoh= C : 3%msoh= month (-) 5%msoh= 10%msoh= Battery usage delayed to minimize the deggradation P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 16 of 22 4.3. Long-Term Optimal Management and System Sizing The long-term optimal management strategy developed in Section 3 allows to estimate the operating costs and number of replacements for a given system configuration and over its entire lifetime. Thus, different installed capacities of solar and storage can be successively tested in order to find the best configurations with regards to the total cost of ownership of the system (TCO in k€) – i.e. summation of capital expenditures, operating and replacement costs over ten years here. Figure 13: Optimal system cost computation (CAPEX, OPEX, and storage replacements) over 10 years for given installed capacities and load/generation profiles. In practice, we considered several possible sizes for the solar and storage capacity: [50, 100, ... 350, 400] kW and kWh. For each of the 36 possible combinations, we simulated all the possible transitions of SoH over one month, in the same spirit as in the Subsection 3.2, but with a discretization of SoH set at 2 %. We then run yearly EMS while tuning both soh0 and ∆soh parameters of the problem. For example, for a given \"PV-storage\" pair, we simulate one month of operation with an initial SoH of 80% and a final SoH of 78%, then 78% - 76% and so on. For each simulation, we store several indicators, such as the normalised exchanged energy and the OPEX of the month in question. Calculating all these combinations and transitions requires a significant computational effort, in this case several hours for all the investigated capacities. The advantage of the DP approach is that this time-consuming simulation only needs to be performed once, in order to solve each of the optimisation \"sub problems\" (i.e. yearly transitions). Once this is done, we can easily determine the SoH trajectories of interest using the approach proposed in Section 3. Thus, there is no engineering time penalty for an energy system designer. The overall architecture to compute the system cost (for given capacities) is illustrated in Figure 13. The approach embeds i) the yearly EMS with ageing (1 hour resolution and monthly SoH updates) and ii) the tailored DP to compute the optimal SoH trajectory over the system lifetime accounting for the storage replacements. The system operating costs over its lifetime is then computed with the optimal sequences of transitions (from the tailored DP) and the yearly transitions cost (from the EMS). , pvR sRpe Installed capacities Yearly EMS – 1h resolution and montlhy SoH update Minimize operating cost (1) s.t. i) operating constraints (2)-(9) ii) SoH monthly update (13)-(19) iii) Yearly deggradation limit (20) Yearly profiles LOOP: For different For different soh0 , pvR sRpe OPEX (k€) for every yealry transition and different values for the loss of SoH APEX (k€) Taylored DP over 10 Years 1) Discretize the problem in states over time SoH levels. 2) Assign transition cost between pairs of states over two successive years – Figure 7. 3) Compute the predecessor of every state at every year – Table 3 4) Reconstruct the optimal path – i.e. SoH trajectory – Figure 8. OPEX (k€) Storage Replacements (k€) Total Cost of Ownership (k€) P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 17 of 22 Regarding the economic aspect of the optimisation, the installation costs cpvR for the solar generator are fixed at 2 k€/kWp [43]. For storage systems, installation costs are set to 500 €/kWh including both electrochemical and power electronics components [44]–[47] in case of second life batteries (i.e. starting at a 80 % of the rated capacity). Replacement of electrochemistry for second life storage costs 75 €/kWh [48]. It is important to notice that these values affect the solution, but do not alter the methodology and the ideas proposed in this paper. Figure 14: Monthly SoH profiles and normalized exchanged energy of the battery over 10 years for the optimal system configuration (ppvR = 200 kWp and esR = 300 kW/kWh) (period : ten years, step size : one month). We can therefore use the DP approach as a sizing tool, to find out which \"PV-storage\" pair has the least expensive SoH trajectory over the lifetime of the project. Among the investigated capacities, optimal results in terms of TCO are obtained with 200 kWp of solar and 300 kWh of second life batteries. Figure 14 displays the results in terms of SoH and monthly exchanged energy profiles for this configuration. Compared to the preliminary results in Figure 5 (ppvR = 100 kWp and esR = 400 kW/kWh) it is worth noting that the optimal management lead to a storage that reaches its end of life (SoH of 60 %) at the end of the project lifespan. This result is expected and validates the proposed approach as any ‘unused SoH’ at the end of the simulated period would suggest that the purchased capacity is wasted. We notice that the installed solar capacity is higher when compared to the previous cases. This is explained by the considered costs of the energy sources, as well as by the lack of any constraint on the PV curtailment. Therefore, the optimal solution for the isolated microgrid in question consists in installing many solar panels in order to minimize the diesel solicitation in the winter months. Consequently, the storage exchanges a significant amount of energy all along the year (and not only during summertime). This increased usage leads to four replacements of the electrochemistry along the project lifetime (90 k€ here). The methodology introduced in the paper focuses on second life battery in order to appropriately consider the loss of capacity over the system lifetime. In order to further highlight the relevance and necessity to account for the storage degradation, a last set of simulation is presented in Table 4. In this table, we compare three distinct case study over 10 years lifespan: ▪ Baseline – No PV and storage are installed, the load is fed uniquely by the genset. ▪ 2 nd life – no degradation: optimal sizing with the installed storage that displays 80 % of its nominal capacity esR over the system lifetime (i.e. no degradation considered). 0 12 24 36 48 60 72 84 96 108 120 0 10 20 30 40 Month (-) 0 60 60 65 70 75 80() exch me −SoH(%) ppvR = 200 kWp and esR = 300 kW/kWh capex = 550 k€ - opex = 311 k€ - 4 replacements = 90 k€ Storage exchanged energy (-) SoH profile (%) P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 18 of 22 ▪ 2 nd life – degradation: optimal sizing with a battery starting at 80 % nominal capacity e sR, the degradation is accounted on a monthly basis with the methodology proposed in this paper. Table 4: System Sizing Results under Various Assumptions Baseline 2nd life no degradation 2nd life degradation ppvR (kW) 0 200 200 esR (kW/kWh) 0 350 300 capex 0 575 k€ 550 k€ opex 1,603 k€ 211 k€ 311 k€ replacement N.A. N.A. 90 k€ TOTAL 1,603 k€ 786 k€ 951 k€ We observe that installing solar panels and storage with an optimal system sizing allows to strongly reduce the total cost of the system by more than half the cost of the baseline. Furthermore, we find that the total estimated cost is 20% higher with the consideration of ageing and the need for replacements (90 € for four replacements along the system lifetime). The sizing of the storage is also impacted by considering the battery degradation. This shows that not considering battery degradation in the sizing and energy management process induces a significant error in the cost estimation. This error is not only due do the replacements, but also to the increased expenditures incurred by the battery ageing – for example, with less available storage capacity, less energy from the PVs can be stored, which increases the utilisation of the genset in the considered use case. Therefore, a methodology such as the one presented in this work is necessary for the proper optimization of the management and sizing of energy systems. Figure 15 : System costs for different configurations around the optimal sizing with degradation effects - a) different storage sizes - b) different solar panel sizes. To further visualize the optimal configuration with the consideration of degradation effects, Figure 15 displays the systems costs (OPEX and CAPEX/replacement costs) when varying the assets capacities. In 50 100 150 200 250 300 350 400 200 450 700 950 1200 Storage Size – esR (kWh)Cost k€ 50 100 150 200 250 300 350 400 200 600 1000 1400 1800 PV Size - ppvR (kWp)Cost k€ ppvR fixed at 200 kWp esR fixed at 300 kWhb)a) OPEX over 10 years CAPEX + storage replacement costs over 10 years Total cost Optimum 3 replacements4 replacements P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 19 of 22 Figure 15a, solar panels are fixed to the optimal size (i.e. 200 kWp). Operating costs tend to decrease with greater storage capacities while the installation expenditures become greater. Also, for battery systems above 300 kWh, less replacements occur with the optimal management of the assets (three instead of four). Indeed, in those cases, the storage usage to minimize the system operating costs incurs lesser amounts of exchanged energy (normalized by the installed capacities), and thus a reduced degradation. Figure 15b displays similar results with a necessary trade-off between operating and capital expenditures while varying the installed solar capacities for a fixed battery size. 5. Conclusion In this work, we proposed a methodology for the integration of Li-ion batteries ageing in an energy system optimisation problem, for both the sizing and for the energy management. The proposed approach can then be used for both operational and long term planning strategies. We have proposed a method to simplify a reference model of cycling ageing for second life batteries, in order to obtain a lighter model that can be integrated into an optimisation problem. Note that the approach can easily be adapted to first life batteries provided that a similar reference model is considered. We validated this simplification hypothesis and showed how it could be translated into constraints in the formulation of the optimisation problem. Especially, results showed that the battery State of Health shall be regularly updated (i.e. on weekly to monthly basis) in order to accurately capture the degradation and loss of capacity. Overall, the ageing is mainly driven by the initial SoH at every update and the energy exchanged between the battery and the system (normalized by the nominal capacity). Also, it has been confirmed that in case of overused storage, disadvantages are somewhat doubled as the degradation over a year is greater for even lesser usage, while the system benefits (in term of operation) are also reduced. For long term simulations and optimal system sizing, we proposed the use of a tailored dynamic programming relying on time and SoH discretizations. That allowed the calculation of an optimal trajectory for the battery SoH over the system lifespan and while considering its potential replacements. Finally, we combined the simplified ageing model and the DP tool to find the optimal sizing of the PV-storage pair for the studied microgrid. The proposed results show that considering battery degradation in the sizing and EMS problem is imperative in order to obtain optimal solutions – we show that not only the sizing of the components can change, but that the total cost of the system is severely misrepresented if ageing is not considered (over 20 % error). In this way, we have proposed a powerful tool to better estimate the costs of using a second-life battery in a real energy system. Future works will go in the direction of further validating the proposed approach, such as in considering other optimisation objectives (such as carbon emissions), considering a first life battery model in order to compare the second life solution, and finally considering other microgrid architectures. 6. Aknowledgment This research is supported by the French National Research Agency under the ”Investissements d’avenir” program (ANR-15-IDEX-02) through the Cross Disciplinary Program CIRCULAR. 7. References [1] IEA, “Net Zero by 2050 - A Roadmap for the Global Energy Sector,” International Energy Agency, Oct. 2021. [2] J. Neubauer, K. Smith, E. Wood, and A. Pesaran, “Identifying and Overcoming Critical Barriers to Widespread Second Use of PEV Batteries,” NREL/TP--5400-63332, 1171780, Feb. 2015. doi: 10.2172/1171780. P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 20 of 22 [3] A. Barré, B. Deguilhem, S. Grolleau, M. Gérard, F. Suard, and D. Riu, “A review on lithium-ion battery ageing mechanisms and estimations for automotive applications,” J. Power Sources, vol. 241, pp. 680– 689, Nov. 2013, doi: 10.1016/j.jpowsour.2013.05.040. [4] M. Johnen, S. Pitzen, U. Kamps, M. Kateri, P. Dechent, and D. U. Sauer, “Modeling long-term capacity degradation of lithium-ion batteries,” J. Energy Storage, p. 102011, Dec. 2020, doi: 10.1016/j.est.2020.102011. [5] E. Redondo-Iglesias, P. Venet, and S. Pelissier, “Modelling Lithium-Ion Battery Ageing in Electric Vehicle Applications—Calendar and Cycling Ageing Combination Effects,” Batteries, vol. 6, no. 1, p. 14, Feb. 2020, doi: 10.3390/batteries6010014. [6] I. Laresgoiti, S. Käbitz, M. Ecker, and D. U. Sauer, “Modeling mechanical degradation in lithium ion batteries during cycling: Solid electrolyte interphase fracture,” J. Power Sources, vol. 300, pp. 112–122, Dec. 2015, doi: 10.1016/j.jpowsour.2015.09.033. [7] B. Xu, A. Oudalov, A. Ulbig, G. Andersson, and D. S. Kirschen, “Modeling of Lithium-Ion Battery Degradation for Cell Life Assessment,” IEEE Trans. Smart Grid, vol. 9, no. 2, pp. 1131–1140, Mar. 2018, doi: 10.1109/TSG.2016.2578950. [8] Y. Xing, E. W. M. Ma, K.-L. Tsui, and M. Pecht, “An ensemble model for predicting the remaining useful performance of lithium-ion batteries,” Microelectron. Reliab., vol. 53, no. 6, pp. 811–820, Jun. 2013, doi: 10.1016/j.microrel.2012.12.003. [9] J. Wang et al., “Cycle-life model for graphite-LiFePO4 cells,” J. Power Sources, vol. 196, no. 8, pp. 3942– 3948, Apr. 2011, doi: 10.1016/j.jpowsour.2010.11.134. [10] M. Ecker et al., “Calendar and cycle life study of Li(NiMnCo)O2-based 18650 lithium-ion batteries,” J. Power Sources, vol. 248, pp. 839–851, Feb. 2014, doi: 10.1016/j.jpowsour.2013.09.143. [11] A. Rezaee Jordehi, “Allocation of distributed generation units in electric power systems: A review,” Renew. Sustain. Energy Rev., vol. 56, pp. 893–905, Apr. 2016, doi: 10.1016/j.rser.2015.11.086. [12] I. Mathews, B. Xu, W. He, V. Barreto, T. Buonassisi, and I. M. Peters, “Technoeconomic model of second- life batteries for utility-scale solar considering calendar and cycle aging,” Appl. Energy, vol. 269, p. 115127, Jul. 2020, doi: 10.1016/j.apenergy.2020.115127. [13] D. Fioriti, L. Pellegrino, G. Lutzemberger, E. Micolano, and D. Poli, “Optimal sizing of residential battery systems with multi-year dynamics and a novel rainflow-based model of storage degradation: An extensive Italian case study,” Electr. Power Syst. Res., vol. 203, p. 107675, Feb. 2022, doi: 10.1016/j.epsr.2021.107675. [14] M. Guo, Y. Mu, H. Jia, Y. Deng, X. Xu, and X. Yu, “Electric/thermal hybrid energy storage planning for park-level integrated energy systems with second-life battery utilization,” Adv. Appl. Energy, vol. 4, p. 100064, Nov. 2021, doi: 10.1016/j.adapen.2021.100064. [15] M. Shabani, F. Wallin, E. Dahlquist, and J. Yan, “Techno-economic assessment of battery storage integrated into a grid-connected and solar-powered residential building under different battery ageing models,” Appl. Energy, vol. 318, p. 119166, Jul. 2022, doi: 10.1016/j.apenergy.2022.119166. [16] I. Rychlik, “A new definition of the rainflow cycle counting method,” Int. J. Fatigue, vol. 9, no. 2, pp. 119–121, Apr. 1987, doi: 10.1016/0142-1123(87)90054-5. [17] A. Bracale, P. Caramia, G. Carpinelli, E. Mancini, and F. Mottola, “Optimal control strategy of a DC micro grid,” Int. J. Electr. Power Energy Syst., vol. 67, pp. 25–38, May 2015, doi: 10.1016/j.ijepes.2014.11.003. [18] X. Dong, G. Bao, Z. Lu, Z. Yuan, and C. Lu, “Optimal Battery Energy Storage System Charge Scheduling for Peak Shaving Application Considering Battery Lifetime,” in Informatics in Control, Automation and Robotics, vol. 133, D. Yang, Ed. Berlin, Heidelberg: Springer Berlin Heidelberg, 2011, pp. 211–218. doi: 10.1007/978-3-642-25992-0_30. [19] R. Dufo-López and J. L. Bernal-Agustín, “Multi-objective design of PV–wind–diesel–hydrogen–battery systems,” Renew. Energy, vol. 33, no. 12, pp. 2559–2572, Dec. 2008, doi: 10.1016/j.renene.2008.02.027. P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 21 of 22 [20] K. Wu and H. Zhou, “A multi-agent-based energy-coordination control system for grid-connected large- scale wind–photovoltaic energy storage power-generation units,” Sol. Energy, vol. 107, pp. 245–259, Sep. 2014, doi: 10.1016/j.solener.2014.05.012. [21] Y. Shi, B. Xu, Y. Tan, and B. Zhang, “A Convex Cycle-based Degradation Model for Battery Energy Storage Planning and Operation,” in 2018 Annual American Control Conference (ACC), Milwaukee, WI, USA, Jun. 2018, pp. 4590–4596. doi: 10.23919/ACC.2018.8431814. [22] J. Huang, S. Wang, W. Xu, W. Shi, and C. Fernandez, “A Novel Autoregressive Rainflow—Integrated Moving Average Modeling Method for the Accurate State of Health Prediction of Lithium-Ion Batteries,” Processes, vol. 9, no. 5, p. 795, Apr. 2021, doi: 10.3390/pr9050795. [23] H. Radet, X. Roboam, B. Sareni, and R. Rigo-Mariani, “Dynamic aware aging design of a simple distributed energy system: A comparative approach with single stage design strategies,” Renew. Sustain. Energy Rev., vol. 147, p. 111104, Sep. 2021, doi: 10.1016/j.rser.2021.111104. [24] J.-Y. Dieulot, F. Colas, L. Chalal, and G. Dauphin-Tanguy, “Economic supervisory predictive control of a hybrid power generation plant,” Electr. Power Syst. Res., vol. 127, pp. 221–229, Oct. 2015, doi: 10.1016/j.epsr.2015.06.006. [25] S. Ebbesen, P. Elbert, and L. Guzzella, “Battery State-of-Health Perceptive Energy Management for Hybrid Electric Vehicles,” IEEE Trans. Veh. Technol., vol. 61, no. 7, pp. 2893–2900, Sep. 2012, doi: 10.1109/TVT.2012.2203836. [26] P. Haessig, H. Ben Ahmed, and B. Multon, “Energy storage control with aging limitation,” in 2015 IEEE Eindhoven PowerTech, Eindhoven, Netherlands, Jun. 2015, pp. 1–6. doi: 10.1109/PTC.2015.7232683. [27] P. V. H. Seger, P.-X. Thivel, and D. Riu, “A second life Li-ion battery ageing model with uncertainties: From cell to pack analysis,” J. Power Sources, vol. 541, p. 231663, Sep. 2022, doi: 10.1016/j.jpowsour.2022.231663. [28] M. Liu, W. Li, C. Wang, M. P. Polis, L. Y. Wang, and J. Li, “Reliability Evaluation of Large Scale Battery Energy Storage Systems,” IEEE Trans. Smart Grid, vol. 8, no. 6, pp. 2733–2743, Nov. 2017, doi: 10.1109/TSG.2016.2536688. [29] E. Namor, D. Torregrossa, F. Sossan, R. Cherkaoui, and M. Paolone, “Assessment of battery ageing and implementation of an ageing aware control strategy for a load leveling application of a lithium titanate battery energy storage system,” presented at the 2016 IEEE 17th Workshop on Control and Modeling for Power Electronics (COMPEL), 2016, p. 6. [30] P. G. Anselma, P. Kollmeyer, J. Lempert, Z. Zhao, G. Belingardi, and A. Emadi, “Battery state-of-health sensitive energy management of hybrid electric vehicles: Lifetime prediction and ageing experimental validation,” Appl. Energy, vol. 285, p. 116440, Mar. 2021, doi: 10.1016/j.apenergy.2021.116440. [31] M. Y. Nguyen and Y. T. Yoon, “Optimal scheduling and operation of battery/wind generation system in response to real-time market prices: OPTIMAL SCHEDULING AND OPERATION OF BATTERY/WIND GENERATION SYSTEM,” IEEJ Trans. Electr. Electron. Eng., vol. 9, no. 2, pp. 129– 135, Mar. 2014, doi: 10.1002/tee.21947. [32] S. Torre, J. M. González‐González, J. A. Aguado, and S. Martín, “Optimal battery sizing considering degradation for renewable energy integration,” IET Renew. Power Gener., vol. 13, no. 4, pp. 572–577, Mar. 2019, doi: 10.1049/iet-rpg.2018.5489. [33] Y. Li, M. Vilathgamuwa, S. S. Choi, T. W. Farrell, N. T. Tran, and J. Teague, “Development of a degradation-conscious physics-based lithium-ion battery model for use in power system planning studies,” Appl. Energy, vol. 248, pp. 512–525, Aug. 2019, doi: 10.1016/j.apenergy.2019.04.143. [34] Y. Li et al., “Design of minimum cost degradation-conscious lithium-ion battery energy storage system to achieve renewable power dispatchability,” Appl. Energy, vol. 260, p. 114282, Feb. 2020, doi: 10.1016/j.apenergy.2019.114282. P. V. H. Seger, R. Rigo-Mariani et al. – paper published in Applied Energy, 2023 Page 22 of 22 [35] A. Maheshwari, N. G. Paterakis, M. Santarelli, and M. Gibescu, “Optimizing the operation of energy storage using a non-linear lithium-ion battery degradation model,” Appl. Energy, vol. 261, p. 114360, Mar. 2020, doi: 10.1016/j.apenergy.2019.114360. [36] R. Rigo-Mariani, S. Ooi Chea Wae, S. Mazzoni, and A. Romagnoli, “Comparison of optimization frameworks for the design of a multi-energy microgrid,” Appl. Energy, vol. 257, p. 113982, Jan. 2020, doi: 10.1016/j.apenergy.2019.113982. [37] R. A. Waltz, J. L. Morales, J. Nocedal, and D. Orban, “An interior algorithm for nonlinear optimization that combines line search and trust region steps,” Math. Program., vol. 107, no. 3, pp. 391–408, Jul. 2006, doi: 10.1007/s10107-004-0560-5. [38] E. Coron, S. Geniès, M. Cugnet, and P. X. Thivel, “Impact of Lithium-Ion Cell Condition on Its Second Life Viability,” J. Electrochem. Soc., vol. 167, no. 11, p. 110556, Jul. 2020, doi: 10.1149/1945- 7111/aba703. [39] C. D’Ambrosio, A. Lodi, and S. Martello, “Piecewise linear approximation of functions of two variables in MILP models,” Oper. Res. Lett., vol. 38, no. 1, pp. 39–46, Jan. 2010, doi: 10.1016/j.orl.2009.09.005. [40] R. Bellman, Dynamic programming. Princeton, NJ: Princeton Univ. Pr, 1984. [41] Z. Song, H. Hofmann, J. Li, X. Han, and M. Ouyang, “Optimization for a hybrid energy storage system in electric vehicles using dynamic programing approach,” Appl. Energy, vol. 139, pp. 151–162, Feb. 2015, doi: 10.1016/j.apenergy.2014.11.020. [42] B. Finnah, J. Gönsch, and F. Ziel, “Integrated day-ahead and intraday self-schedule bidding for energy storage systems using approximate dynamic programming,” Eur. J. Oper. Res., vol. 301, no. 2, pp. 726– 746, Sep. 2022, doi: 10.1016/j.ejor.2021.11.010. [43] A. Nadal, “Influence des incertitudes sur l’optimisation technico-économique de systèmes énergétiques hybrides,” Université Grenoble Alpes, 2019. [44] W. Cole, A. W. Frazier, and C. Augustine, “Cost Projections for Utility-Scale Battery Storage: 2021 Update,” National Renewable Energy Laboratory, 2021. [45] E. Minear, “Battery Energy Storage Lifecyle Cost Assessment Summary: 2020,” 2020. [46] R. Madlener and A. Kirmas, “Economic Viability of Second Use Electric Vehicle Batteries for Energy Storage in Residential Applications,” Energy Procedia, vol. 105, pp. 3806–3815, May 2017, doi: 10.1016/j.egypro.2017.03.890. [47] T. Steckel, A. Kendall, and H. Ambrose, “Applying levelized cost of storage methodology to utility-scale second-life lithium-ion battery energy storage systems,” Appl. Energy, vol. 300, p. 117309, Oct. 2021, doi: 10.1016/j.apenergy.2021.117309. [48] H. Ambrose, A. Kendall, M. Slattery, and T. Steckel, “Battery Second-Life: Unpacking Opportunities and Barriers for the Reuse of Electric Vehicle Batteries.” 2020.","libVersion":"0.3.1","langs":""}