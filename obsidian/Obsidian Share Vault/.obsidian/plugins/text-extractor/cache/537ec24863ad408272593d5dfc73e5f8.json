{"path":"lit/lit_notes_OLD_PARTIAL/Cramer23electPriceFrcstNormFlow.pdf","text":"Page 1 of 20 Multivariate Probabilistic Forecasting of Intraday Electricity Prices using Normalizing Flows Eike Cramer a,b , Dirk Witthaut c,d , Alexander Mitsos e,a,b , Manuel Dahmena,∗ a Forschungszentrum Jülich GmbH, Institute of Energy and Climate Research, Energy Systems Engineering (IEK-10), Jülich 52428, Germany b RWTH Aachen University, Process Systems Engineering (AVT.SVT), Aachen 52074, Germany c Forschungszentrum Jülich GmbH, Institute of Energy and Climate Research, Systems Analysis and Technology Evaluation (IEK-STE), Jülich 52428, Germany d Institute for Theoretical Physics, University of Cologne, 50937 Köln, Germany e JARA-ENERGY, Jülich 52425, Germany Electricity is traded on various markets with diﬀerent time horizons and regulations. Short-term intraday trading becomes increasingly important due to the higher penetration of renewables. In Germany, the intraday electricity price typically ﬂuctuates around the day-ahead price of the European Power EX- change (EPEX) spot markets in a distinct hourly pattern. This work proposes a probabilistic modeling approach that models the intraday price diﬀerence to the day-ahead contracts. The model captures the emerging hourly pattern by considering the four 15 min intervals in each day-ahead price interval as a four-dimensional joint probability distribution. The resulting nontrivial, multivariate price diﬀerence distribution is learned using a normalizing ﬂow, i.e., a deep generative model that combines conditional multivariate density estimation and probabilistic regression. Furthermore, this work discusses the inﬂu- ence of diﬀerent external impact factors based on literature insights and impact analysis using explainable artiﬁcial intelligence (XAI). The normalizing ﬂow is compared to an informed selection of historical data and probabilistic forecasts using a Gaussian copula and a Gaussian regression model. Among the diﬀer- ent models, the normalizing ﬂow identiﬁes the trends with the highest accuracy and has the narrowest prediction intervals. Both the XAI analysis and the empirical experiments highlight that the immediate history of the price diﬀerence realization and the increments of the day-ahead price have the most sub- stantial impact on the price diﬀerence. Keywords: Electricity price forecasting; probabilistic forecasting; deep learning; multivariate modeling 1 Introduction The liberalization of the European electricity mar- kets has introduced the auction-based day-ahead market and the continuously traded intraday mar- ket (Mayer and Trück, 2018). The hourly day- ahead auction market is cleared on the day before delivery. Afterward, the continuous 15 min inter- val intraday markets aim to reduce the balance re- quirements by enabling short-term changes to de- livery and consumption commitments and react to the ramping of supply and demand (Ocker and Ehrhart, 2017; European Power Exchange, 2021; Bublitz et al., 2019). The increasing penetration of renewable electricity sources with low marginal cost (Sensfuß et al., 2008) causes intraday prices to become more volatile (Viehmann, 2017; Shinde and Amelin, 2019). Thus, electricity price forecasting (EPF) (Weron, 2014) for the intraday market be- comes increasingly diﬃcult (Lago et al., 2021; Je- drzejewski et al., 2022a) as the forecasts have to account for the inherent uncertainty of intermittent renewable electricity supply and human interaction on the continuous market (Mayer and Trück, 2018; Bublitz et al., 2019). Still, accurate forecasts of in- traday prices can lead to signiﬁcant ﬁnancial gains (Seraﬁn et al., 2022). A promising approach to address the uncertainty in EPF uses probabilistic forecasting models that predict a distribution of possible realizations in- stead of a single point forecast (Zhang et al., 2003; Nowotarski and Weron, 2018). The quantitative knowledge of the uncertainty allows the market par- ticipants to develop diﬀerent strategies consider- ing possible outcomes and to derive more eﬀective bidding strategies (Nowotarski and Weron, 2018). Established approaches for probabilistic forecast- ing include prediction intervals (Zhang et al., 2003; Serinaldi, 2011; Jónsson et al., 2014; Uniejewski and Weron, 2021) and density forecasts (Huurman et al., 2012; Panagiotelis and Smith, 2008; Andrade et al., 2017; Narajewski and Ziel, 2020b). Other works use ensemble forecasts (Narajewski and Ziel, 2020b) or ∗Manuel Dahmen, Forschungszentrum Jülich GmbH, Institute of Energy and Climate Research, Energy Systems Engineering (IEK-10), Jülich 52428, Germany E-mail: m.dahmen@fz-juelich.dearXiv:2205.13826v4 [cs.LG] 10 Mar 2023 Page 2 of 20 propose combinations of deterministic and proba- bilistic approaches (Marcjasz et al., 2020). There is also an increasing trend towards machine learning methods (Jedrzejewski et al., 2022b). Most probabilistic EPF papers utilize univari- ate modeling approaches (Nowotarski and Weron, 2018). Here, the models predict single time steps in a step-by-step fashion and consider the correlation between time steps via the autoregressive compo- nents. Alternatively, multivariate models predict sequences in multi-step forecasting (Panagiotelis and Smith, 2008; Ziel and Weron, 2018). For in- stance, Panagiotelis and Smith (2008) use a mul- tivariate student-t distribution model for intraday prices in Australia. In a study on deterministic fore- casting models, Ziel and Weron (2018) report on the advantages of using a multivariate approach for day-ahead EPF. Most of the literature on proba- bilistic EPF only considers the day-ahead markets (Lago et al., 2021). A notable exception is presented by Andrade et al. (2017), who perform probabilistic forecasting for both day-ahead and intraday mar- kets. The literature on intraday EPF generally ad- dresses the intraday prices as a stand-alone pre- diction problem without considering the relation to the day-ahead prices (Pape et al., 2016; Kremer et al., 2021). However, separating the intraday EPF from the day-ahead prices ignores the connection between the two markets, where the intraday mar- ket mainly serves to make adjustments to the ﬁxed day-ahead contracts (Koch and Hirth, 2019). Con- sequently, the intraday price follows the day-ahead price trend. Furthermore, the adjustments react to the ramping of supply and demand, which leads to steadily increasing or decreasing prices in the four intraday trading intervals of each day-ahead trading interval (Kiesel and Paraschiv, 2017). Thus, there is a distinct hourly ﬂuctuation of the intraday prices around the day-ahead prices that averages to the day-ahead price (Han et al., 2022). This work proposes a modeling approach for intraday electricity prices that exploits the spe- cial relationship between the two electricity mar- kets. Assuming that the intraday EPF is per- formed short-term, i.e., after the day-ahead price is set, the intraday price is modeled via the diﬀer- ence between the two market prices. Furthermore, the hourly increasing or decreasing patterns of the four 15 min intervals of each day-ahead price inter- val are captured using a multivariate forecasting scheme. Hence, the forecasting problem needs to predict the four-dimensional price diﬀerence vector probability distribution which is deﬁned by heavy tails, high correlations between the dimensions, and conditional dependence on external impact factors. Thus, the price diﬀerence vector distribution can- not be modeled via standard probability distribu- tion models. Instead, this work uses normalizing ﬂows (Papamakarios et al., 2021), a non-parametric, i.e., fully data-driven, distribution model, to learn the probability distribution of the price diﬀerence vector. Normalizing ﬂows learn complex distri- butions without a priori assumptions about the data and can include external impact factors for probabilistic regression (Winkler et al., 2019; Rasul et al., 2021). For scenario generation of other en- ergy time series, such as renewable electricity gen- eration and electricity demand, normalizing ﬂows have already shown promising results (Dumas et al., 2022; Cramer et al., 2022a,b; Arpogaus et al., 2021). The forecasting performance of the normalizing ﬂow is compared to an informed selection of historical data, a Gaussian copula, and a multivariate Gaus- sian regression. Both day-ahead and intraday prices are heavily inﬂuenced by external impact factors such as re- newable electricity generation, import and export, and demand (Trebbien et al., 2022). However, the literature is scarce on evaluations on the impact fac- tors for the price diﬀerences analyzed and mod- eled in this study. Thus, this work investigates the impact of diﬀerent external factors on the real- ization of the price diﬀerence vector using explain- able artiﬁcial intelligence (XAI). XAI is a branch of machine-learning research aiming to design human- understandable models and post-modeling explana- tions for black-box models (Gunning, 2017; Tjoa and Guan, 2020). An important subbranch of post- modeling explanations in XAI considers the pre- dictability of the desired labels or values given the considered input features (Lundberg et al., 2020). In particular, this work uses SHAP-values (SHap- ley Additive exPlanations), which are a typical ap- proach to quantify the impact of each input fea- ture on the output of the machine-learning model. In previous works, SHAP-values have been suc- cessfully applied to analyze the predictability of power grid frequencies (Kruse et al., 2020), to reveal drivers and risks for power grid frequency stability (Kruse et al., 2021), predict the electricity mix in the African grid (Alova et al., 2021), and to gain insight into solar power forecasting (Kuzlu et al., 2020). The remainder of this work is organized as fol- lows: Section 2 introduces the four-dimensional 2 Page 3 of 20 price diﬀerence modeling approach and highlights the advantages of multivariate modeling over the traditional univariate approach. Section 3 intro- duces the diﬀerent multivariate probabilistic mod- els. Section 4 discusses relevant external input fac- tors and performs the feature selection using SHAP- values analysis. Section 5 applies the diﬀerent dis- tribution modeling approaches to learn the four- dimensional conditional distribution and discusses the impact of each external input factor via an em- pirical study. Finally, Section 6 concludes this work. 2 Electricity price analysis This Section ﬁrst describes the used data sets. Sec- ond, an approach for multivariate modeling of in- traday electricity prices is proposed. Finally, the Section compares a univariate and a multivariate sampling approach for the price diﬀerence vector using assessment scores for multivariate probabilis- tic forecasting. 2.1 Data description The majority of electricity is traded on the auction- based day-ahead market, while the intraday mar- ket is primarily used to make short-term adjust- ments to the previously submitted bids (Kiesel and Paraschiv, 2017; Koch and Hirth, 2019; Han et al., 2022). The intraday contracts are negotiated be- tween the producers and the consumers on diﬀer- ent time horizons and for diﬀerent periods. Thus, diﬀerent prices occur for the same intraday trad- ing interval (Mayer and Trück, 2018; Ocker and Ehrhart, 2017). As an indicator of the intraday electricity prices, the market operators release in- dices of volume-weighted averages (European Power Exchange, 2021). This work uses the ID3 index, i.e., the index reﬂecting the volume-weighted av- erage price of the last three hours before delivery, as it is the most commonly used indicator (Euro- pean Power Exchange, 2021; Bublitz et al., 2019). The data set considered in this work is the day- ahead and ID3 price time series recorded over the years of 2018 and 2019 provided by the Fraunhofer- Institut für Solare Energiesysteme ISE (2022). The day-ahead forecasts and actual values for the renew- able electricity production and the loads are taken from ENTSO-E Transparency Platform (2022). All renewable electricity time series are recorded in 15 min intervals. Note that the electricity price data from 2020 and 2021 shows atypical behavior due to the COVID-19 pandemic (Michał Narajewski, 2020; 0 6 12 18 24 Time [h] 30 35 40 45 50 55 60Price [EUR/MWh] Average Intraday ID3 Average Day-Ahead Fig. 1. Average daily proﬁles of day-ahead and ID3 price trends of 2018 and 2019. EPEX spot price data from Fraunhofer-Institut für Solare En- ergiesysteme ISE (2022). Badesa et al., 2021) and is, therefore, not included. 2.2 Hourly price diﬀerence vectors The volume of electricity traded on the day-ahead and the intraday markets exempliﬁes the relation- ship between the two markets. In 2019, the volume of day-ahead trades was 501.6 TWh, and the intra- day trades amounted to 83.2 TWh (European Power Exchange (EPEX SPOT), 2020). These numbers highlight how traders primarily trade on the day- ahead market and then adjust their bids on the in- traday market. Intraday trades address ramping of supply and demand within the day-ahead trading intervals and compensate for forecast errors of de- mand and renewable electricity supply (Kiesel and Paraschiv, 2017; Spodniak et al., 2021). In par- ticular, ramping of large suppliers and consumers leads to a distinct pattern of increasing or decreas- ing intraday prices within each day-ahead trading interval (Kiesel and Paraschiv, 2017). For instance, a scheduled ramp-up of electricity supply results in an undersupply in the ﬁrst 15 minutes and an over- supply in the last 15 minutes of the respective hour, which leads to higher prices in the ﬁrst 15 minutes and lower prices in the last 15 minutes, respectively. Thus, the hour-wise constant day-ahead contracts lead to hourly patterns in the 15 min intraday prices (Kiesel and Paraschiv, 2017; Han et al., 2022). Figure 1 shows the average daily day-ahead and intraday prices in 2018 and 2019, i.e., each step represents the average price interval over the two years. As indicated by Kiesel and Paraschiv (2017), the average ID3 price within each hour is close to the respective day-ahead price. Furthermore, the ID3 price either increases or decreases within the 3 2.3 Analysis of the price diﬀerence vector distribution Page 4 of 20 respective day-ahead trading intervals. These ob- servations lead to the following conclusions about the relationship of the two price time series: First, the ID3 index ﬂuctuates around the day-ahead auc- tion price. Second, Figure 1 highlights that the dis- tinct hourly patterns of either increasing or decreas- ing steps appear systematically. Exceptions of this pattern only appear at local minima and maxima of the day-ahead price. In summary, the relationship between the day-ahead and the intraday markets as primary and adjustment markets leads to a distinct hourly pattern of intraday price ﬂuctuations around the day-ahead prices. The proposed modeling-approach for the ID3 price index aims to capture the observed patterns. Since the intraday market is used for adjustments to the day-ahead market, the diﬀerence between the two price time series represents the characteristics of the intraday market. Assuming that the pre- diction takes place after the day-ahead auction has been settled and the day-ahead prices are known, the ID3 price index can be described via the sum of the day-ahead price and the diﬀerence between the two price time series. Furthermore, the hourly pat- tern of ﬂuctuations is captured by modeling the four steps of price diﬀerences in each day-ahead trading interval as a four-dimensional vector. For a given hour t the price diﬀerence vector ∆ID3 then reads: ∆ID3(t) =     ID00 3 (t) − DA(t) ID15 3 (t) − DA(t) ID30 3 (t) − DA(t) ID45 3 (t) − DA(t)     (1) The four dimensions each describe the diﬀerence be- tween intraday (ID XX 3 (t)) and day-ahead (DA(t)) price for a 15 min interval in the hour t. The super- scripts 00, 15, 30, and 45 indicate the starting min- utes of the four intraday trading intervals. Note that while the day-ahead market sets the prices for all time intervals simultaneously, the in- traday market allows for trading up to ﬁve min- utes prior to the delivery, and the prices for each trading interval are, thus, set independently. Intu- itively, a step-by-step forecasting approach, where each step is informed by the previous, could be con- sidered more appropriate than the chosen multivari- ate approach. However, the multivariate modeling approach is speciﬁcally designed to consider the cor- relation between the forecast dimensions, i.e., the four quarter-hour intervals, and there are no limita- tions to the practical application of the multivariate modeling approach. Tab. 1. Pearson correlation within the 4D-∆ID3 distribution (see Equation (2)). Price data from Fraunhofer-Institut für Solare Energiesysteme ISE (2022). ∆ID00 3 ∆ID15 3 ∆ID30 3 ∆ID45 3 ∆ID00 3 1.00 0.77 0.41 0.09 ∆ID15 3 0.77 1.00 0.74 0.46 ∆ID30 3 0.41 0.74 1.00 0.83 ∆ID45 3 0.09 0.46 0.83 1.00 2.3 Analysis of the price diﬀerence vector distribution To showcase the advantage of the multivariate mod- eling approach, this Subsection ﬁrst highlights the strong correlation between the four price diﬀerence time steps in each day-ahead trading interval by showing the Pearson correlation and then compares a univariate and a multivariate sampling approach to highlight how the multivariate approach better captures the correlations between the time steps. Table 1 shows the Pearson correlation of the four dimensions in the joint distribution of price diﬀer- ences, i.e., the autocorrelations of the respective time steps. The correlations between neighboring time steps are high and, thus, highlight the strong correlation between the time steps within each day- ahead trading interval. In fact, it appears that each interval is predetermined by the previous dimen- sion, which motivates the multivariate modeling ap- proach. To conﬁrm that the multivariate approach cap- tures the correlation of neighboring time steps bet- ter than the classical univariate approach, two dif- ferent approaches of univariate and multivariate se- lection of historical data are compared using scor- ing metrics for multivariate probabilistic forecasts. Figure 1 shows a strong dependency of the average realization on the hour of the day. The multivari- ate selection is based on this observation and ran- domly selects historical realizations of the hourly price diﬀerence intervals that occurred during the same hour of the day. Similarly, the univariate se- lection approach randomly selects values that oc- curred during the same 15 min interval and com- bines the selections into four-dimensional samples. Both approaches randomly select price diﬀerences from January 2018 to June 2019. July 2019 is set aside as a test set. Unlike point forecasts, probabilistic forecasts can- not be evaluated by residual metrics such as the 4 Page 5 of 20 mean squared error or the mean absolute error. In- stead, probabilistic forecasts are typically evaluated in terms of reliability and sharpness (Nowotarski and Weron, 2018). Here, reliability describes whether the realization lies within certain predic- tion intervals. Sharpness analyzes the tightness of the prediction intervals, i.e., how close the lower and upper boundaries of the prediction intervals are together (Nowotarski and Weron, 2018). A good probabilistic forecast should be both reliable and sharp to avoid missing the realization and avoid large prediction intervals that carry little informa- tion. To evaluate the diﬀerent sampling approaches, this work uses the energy score (Gneiting and Raftery, 2007; Pinson and Girard, 2012) and the variogram score (Scheuerer and Hamill, 2015). The energy score (Gneiting et al., 2008; Pinson and Gi- rard, 2012) is a widely applied metric for multistep probabilistic forecasts. It assesses how close the pre- diction samples are to the realizations and how di- verse the samples are: ES = 1 N N∑ s=1 ||x − ˆxs||2 − 1 2N 2 N∑ s=1 N∑ s′=1 ||ˆxs − ˆxs′||2 Here, x is the realized ID3 price-vector, i.e., the actual realization from the test set, ˆxs are sample vectors drawn from the predicted distributions, N is the number of samples, and || · ||2 is the 2-norm. The variogram score (Scheuerer and Hamill, 2015) aims to assess whether a multivariate forecast cor- rectly describes the correlation between the individ- ual time steps: VS = 1 N ˆT∑ t=1 ˆT∑ t′ =1 ( |xt − xt′ | γ − 1 N N∑ s=1 |ˆxs t − ˆxs t ′ |γ)2 Here, xt are the realized ID3 price time steps, ˆxt are time steps of samples from the predicted ID3 distri- bution, ˆT = 4 is the dimension of x, i.e., the number of 15 min intervals in the multivariate prediction, N is the number of samples, γ is the variogram order (typically γ = 0.5 (Scheuerer and Hamill, 2015)), and | · | denotes the absolute value. Both energy score and variogram score are negatively oriented metrics, i.e., lower values indicate better perfor- mance (Scheuerer and Hamill, 2015; Pinson and Gi- rard, 2012). Figure 2 shows box plots (Waskom, 2021) of the energy score and the variogram score distributions of the univariate and the multivariate selection ap- proaches applied to each day-ahead trading interval of the test month, respectively. The multivariate Multivariate Univariate 0 10 20 30 40 50 60Energy Score Multivariate Univariate 0 20 40 60 80 100Variogram Score Fig. 2. Box plots (Waskom, 2021) of the en- ergy score (Gneiting and Raftery, 2007; Pinson and Girard, 2012) and variogram score (Scheuerer and Hamill, 2015) distributions of historical data selected using univariate and multivariate ap- proaches. Price data from January 2018 to June 2019 (Fraunhofer-Institut für Solare Energiesys- teme ISE, 2022) is used and the evaluation is per- formed on July 2019 as the test set. approach yields lower values for energy scores and variogram scores and, thus, indicates better agree- ment with the realizations. In particular, the var- iogram score suggests that the univariate selection fails to represent the correct correlation between the time steps whereas the multivariate approach cap- tures the hourly pattern. In conclusion, the results in Figure 2 conﬁrm that the multivariate approach is better suited to describe the price diﬀerence dis- tribution than a univariate approach. In the fol- lowing, the term historical selection refers to the multivariate selection of historical data. 3 Multivariate probabilistic forecasting of electricity price diﬀerences The realizations of the hourly price diﬀerence vector in Equation (1) follow an unknown four-dimensional joint distribution: ∆ID3 ∼ p∆ID3 (∆ID3) (2) Here, p∆ID3 (∆ID3) is the probability density func- tion (PDF) of the vector-valued random variable ∆ID3. The realizations of the price diﬀerence dis- tribution are assumed to be inﬂuenced by known external factors. Therefore, the proposed modeling approach includes these external factors as input 5 Page 6 of 20 features y to form a conditional distribution: ∆ID3 ∼ p∆ID3|Y (∆ID3|y) (3) Here, p∆ID3|Y (∆ID3|y) is the conditional PDF of ∆ID3 given the input feature y. Forecasting this conditional multivariate probability distribu- tion poses a diﬃcult modeling problem. The prob- ability distribution is of unknown shape and elec- tricity prices are known to exhibit heavy tails (Han et al., 2022). Furthermore, the relationship with the conditional input factors is unknown and likely non- linear. Thus, the proposed probabilistic forecasting approach requires a ﬂexible distribution model that can seamlessly include external input features with potentially nonlinear eﬀects. To model the conditional probability distribution of price diﬀerences described by Equation (3), this work uses the following four approaches: (1) condi- tional normalizing ﬂows (Winkler et al., 2019), (2) the informed selection of historical data presented in Section 2, (3) Gaussian copulas with quantile re- gression (Pinson et al., 2009), and (4) multivariate Gaussian regression (Dillon et al., 2017). The selec- tion of models aims to provide a variety of naïve, established, and recently published approaches. Normalizing ﬂows are non-parametric distribu- tion models that model high-dimensional complex distributions as an invertible neural network trans- formation T , with inverse T −1, of a multivariate standard Gaussian φ(z) (Dinh et al., 2017; Papa- makarios et al., 2021). Utilizing the change of vari- ables formula, normalizing ﬂows describe the con- ditional PDF pX|Y (x|y) of a multivariate random variable X with realizations x and input features y explicitly (Papamakarios et al., 2021; Winkler et al., 2019): pX|Y (x|y) = φ (T −1(x, y)) |det JT −1(x, y)| (4) Here, JT −1 is the Jacobian of the inverse transfor- mation. Normalizing ﬂows make no assumptions about the data structure and distribution. Thus, by using suﬃciently expressive transformations, nor- malizing ﬂows can model any distribution (Papa- makarios et al., 2021). To sample from a normal- izing ﬂow, ﬁrst, samples are drawn from the multi- variate Gaussian, i.e., ˆzi ∼ φ(z). Second, the sam- ples and the conditional inputs are transformed us- ing the forward form of the invertible neural net- work: ˆxi = T (ˆzi, ˆy) ∀i = 1, 2, . . . , N Here, ˆy are the external input features at the re- spective time, which are assumed to be given. Fig- ure 3 shows a sketch of the conditional normalizingExternal input features: 𝒚Normalizing flow Price difference vector: 𝚫𝑰𝑫𝟑~𝑝𝚫𝑰𝑫𝟑|& 𝚫𝑰𝑫𝟑|𝐲𝑇𝐲,𝐳=𝚫𝑰𝑫𝟑 Gaussian: 𝒛~𝜙 𝒛 𝚫𝑰𝑫𝟑 𝑡 − 1ℎ ∆𝑃' () = 𝑃' () − 5𝑃' () … Fig. 3. Multivariate probabilistic forecasting scheme. The external input features are collected in a feature vector y and used to condition the trans- formation of Gaussian samples via the normalizing ﬂow. ﬂow modeling scheme. This work implements the invertible neural network using the real non-volume preserving transformation (RealNVP) (Dinh et al., 2017). The Gaussian copula is a well-established method to describe multivariate distributions with nontriv- ial correlations between the individual dimensions. The basic approach relies on transforming samples from a uniform distribution via an estimated in- verse cumulative distribution function (CDF). In forecasting applications, the inverse CDF is esti- mated via an interpolation of quantile forecasts from quantile regression. For a detailed introduc- tion to the combination with quantile regression, we refer the interested reader to Pinson et al. (2009). The present work uses the quantile regression im- plemented in the ‘statsmodels’ library (Seabold and Perktold, 2010). Finally, the multivariate Gaussian regression uses neural networks to predict the mean vector µX and the covariance matrix ΣX of the multivariate Gaus- sian as a function of the conditional inputs y (Dillon et al., 2017): pX|Y (x|y) = NX|Y (x; µX (y), ΣX (y)) (5) As the covariance matrix is symmetric, the neural network only needs to predict a lower-triangular version of ΣX (y) (Dillon et al., 2017). The pre- dicted mean and covariance can then be used to sample from the Gaussian distribution parameter- ized by the predicted values. In all models, the electricity price diﬀerence vec- tor ∆ID3 takes the role of the random variable X, and the external factors are the conditional in- put features Y . For every realization of the ex- ternal factors y, the models allow sampling from the electricity price diﬀerence vector distribution 6 Page 7 of 20 ˆ∆ID3 ∼ p∆ID3 as described for the normalizing ﬂow above. 4 Input feature selection The realizations of both the day-ahead and the in- traday prices are inﬂuenced by external factors such as the residual loads (Kiesel and Paraschiv, 2017). However, the driving factors for the electricity price diﬀerence vector are likely to be diﬀerent compared to those for the absolute day-ahead and intraday prices. In particular, the diﬀerence alleviates the impact of some external factors and ampliﬁes the impact of others. Hence, the selection of input fea- tures should not be based on the standard inputs for day-ahead or intraday price forecasting known in the literature. This Section aims to ﬁnd a highly informative set of external factors that should be included as in- put features to the models in Section 3. First, Sec- tion 4.1 derives a set of possible input feature based on literature impressions and an analysis of the price time series. Second, Section 4.2 uses explain- able artiﬁcial intelligence (XAI) to narrow down the full set to a highly informative subset of input fea- tures. 4.1 Possible input features The day-ahead prices are determined by the inter- section of supply and demand (Pape et al., 2016; Gürtler and Paulsen, 2018) and inﬂuenced by the merit-order curve (Kremer et al., 2021). The intra- day markets are used to adjust the previously sub- mitted bids to address short-term changes in supply and demand. Thus, the impact of the forecasted total electricity demand and the forecasted total renewable electricity supply is already reﬂected in the day-ahead prices and has little inﬂuence on the diﬀerence between day-ahead prices and intraday prices (Kiesel and Paraschiv, 2017; Spodniak et al., 2021; Han et al., 2022). The diﬀerences are mostly impacted by the forecasting errors in the residual load, i.e., for load and renewable electricity genera- tion (Kiesel and Paraschiv, 2017; Han et al., 2022). For the absolute intraday prices, Kalukov and Ziel (Kulakov and Ziel, 2019) show that the impact of forecast errors is nonlinear. Notably, the actual re- newable forecast errors are only known a posteriori. Hence, these values are neither known to intraday traders, nor can they be applied in actual forecasts of the intraday prices. However, hour-ahead renew- able forecast are available (Sweeney et al., 2020) and can be used to correct day-ahead forecasts, thus aﬀecting the intraday electricity prices. Unfor- tunately, these hour-ahead renewable forecasts are not publicly available. Hence, we use the a poste- riori renewable forecasting errors as a proxi in our analysis: ∆P RE t = P RE t − ˆP RE t RE ∈ {Solar, Wind, Load} Here, P RE t is the actual, ˆP RE t is the day-ahead fore- cast. Another important external factor for the ﬂuctu- ation of the intraday prices is the ramping of re- newables and load (Koch and Hirth, 2019). For instance, solar electricity generation ramps up in the morning and ramps down in the evening, which leads to large changes in solar power supply within single day-ahead trading intervals (Koch and Hirth, 2019). Wolﬀ and Feuerriegel (2017) and Ocker and Ehrhart (2017) ﬁnd that the ratio of conventional and renewable electricity impacts the realizations of both day-ahead and intraday prices. To investigate the impact of the share of conventional electricity, the prices of oil and natural gas are considered as input factors. Han et al. (2022) ﬁnd that the increments of the day-ahead price, i.e., the diﬀerence between one hour and the next, have a substantial impact on the direction (increasing or decreasing) and the in- tensity of the hourly ﬂuctuation. This observa- tion is conﬁrmed by the average daily price pro- ﬁles shown in Figure 1. For increasing or decreas- ing day-ahead prices, the hourly ﬂuctuation shows increasing or decreasing patterns, respectively. Fur- thermore, larger increments appear to induce more signiﬁcant ﬂuctuations and vice versa. For local minimum and maximum peak hours in the day- ahead price, Figure 1 shows no distinct trend of the ﬂuctuation. Figure 1 also indicates that the realizations of the price diﬀerences depend on the time of the day. Thus, the list of possible input features includes a trigonometric encoding of the hour of the day (Moon et al., 2019). Narajewski and Ziel (2020a) and Han et al. (2022) state that the day-ahead markets in Germany are weak-form eﬃcient, i.e., the recent history of day- ahead prices does not inform on future realizations, whereas for intraday prices, there is an advantage from including the most recent value in the predic- tion. To evaluate the impact of prior realizations on the price diﬀerence, Figure 4 shows the Pearson autocorrelation function (ACF) of the day-ahead price, the intraday price, and the diﬀerence between 7 4.2 Input feature selection via explainable AI Page 8 of 20 0 12 24 36 48 Lag [h] 0.0 0.2 0.4 0.6 0.8 1.0ACF [-] Day-ahead price ID3-Index price Price difference ID3 Fig. 4. Pearson autocorrelation (ACF) of day- ahead price (“Day-ahead price”), ID3 index (“ID3- Index price”), and diﬀerence between the two time series (“Price diﬀerence ∆ID3”) with time lag of 0 to 48 h. EPEX spot price data in 2018 and 2019 from Fraunhofer-Institut für Solare Energiesysteme ISE (2022). the two time series for time lags up to 48 h. The ACF of the price diﬀerence drops quickly to val- ues that are signiﬁcantly lower compared to those for the day-ahead ACF and the intraday ACF that persist at high levels over 0.3 over longer time spans. After the rapid drop-oﬀ, the price diﬀerence ACF ﬂuctuates at a low level under 0.2 indicating neg- ligible impact for forecasting tasks. Yet, the ﬁrst few hours still show high ACF values. Thus, the two previous hours are included as possible fea- tures. The supplementary material of this work shows further analysis of the time dependency on longer scales. Notably, the price diﬀerence time se- ries does not show any signiﬁcant trends over the days of the week or the months of the year over the considered dataset. In the following, the possible input features are considered in three groups: The forecast error fea- tures, the ramping features, and the price and time features. The considered feature labels and their descriptions are listed in Table 2, 3, and 4, respec- tively. 4.2 Input feature selection via ex- plainable AI To improve usability and to avoid overﬁtting of the forecasting models, the set of input features should be narrowed down to a highly informative sub- set. While relevant external impact factors for day- ahead and intraday prices are well studied within the literature (Wolﬀ and Feuerriegel, 2017; Treb- Tab. 2. Price and time feature labels. The variable t denotes the considered time interval in hours. Description Labels Day Ahead Auction DA Day Ahead Increments back ∆DA − Day Ahead Increments ahead ∆DA + cosine time encoding cos(t) sine time encoding sin(t) DA − ID3 at t-1 h (1st interval) ∆ID00 3 (t − 1h) DA − ID3 at t-1 h (2nd interval) ∆ID15 3 (t − 1h) DA − ID3 at t-1 h (3rd interval) ∆ID30 3 (t − 1h) DA − ID3 at t-1 h (4th interval) ∆ID45 3 (t − 1h) DA − ID3 at t-2 h (1st interval) ∆ID00 3 (t − 2h) DA − ID3 at t-2 h (2nd interval) ∆ID15 3 (t − 2h) DA − ID3 at t-2 h (3rd interval) ∆ID30 3 (t − 2h) DA − ID3 at t-2 h (4th interval) ∆ID45 3 (t − 2h) Tab. 3. Forecast error feature labels. Description Labels Solar Error [MW] (1 st interval) Solar Error 00 Solar Error [MW] (2 nd interval) Solar Error 15 Solar Error [MW] (3 rd interval) Solar Error 30 Solar Error [MW] (4 th interval) Solar Error 45 Load Error [MW] (1 st interval) Load Error 00 Load Error [MW] (2 nd interval) Load Error 15 Load Error [MW] (3 rd interval) Load Error 30 Load Error [MW] (4 th interval) Load Error 45 Wind Error [MW] (1 st interval) Wind Error 00 Wind Error [MW] (2 nd interval) Wind Error 15 Wind Error [MW] (3 rd interval) Wind Error 30 Wind Error [MW] (4 th interval) Wind Error 45 Tab. 4. Day-ahead ramping feature labels. Description Labels Solar DA solar ramp Wind DA wind ramp Load DA load ramp Total power generation DA total gen ramp Import/export DA import/export ramp 8 4.2 Input feature selection via explainable AI Page 9 of 20 bien et al., 2022), there is no evaluation of impact factors for the diﬀerence between the two prices. The previous Section lists a number of possible in- put features. However, the true eﬀect on the re- alization of the price diﬀerences remains unknown. This work uses XAI to ﬁnd the most impactful in- put features. In particular, the explanatory power of SHAP-values is used to quantify the impact of each input feature and, thus, make informed deci- sions for the feature set selection. Given a model f (y) with feature vector y, the SHAP-value approach (Lundberg et al., 2020) de- composes each model prediction into the contribu- tions of the individual features: f (y) = ϕ0 + ∑ i ϕi(yi; f ), (6) where ϕ0 = EY (f (y)) is a constant oﬀset and ϕi are the SHAP-values of the respective input fea- tures yi ∈ y. The SHAP-value decomposition ensures consistent interpretability, and the indi- vidual SHAP-values quantify the contribution of each input feature towards the model output value. The SHAP value method is designed speciﬁcally to quantify the impact of each input feature consid- ering all possible (nonlinear) combinatorial eﬀects represented in the model f (y). Hence, SHAP val- ues are not restricted to simple marginal feature perturbations under the ceteris parbus assumption. They capture the contribution of a given feature for all possible coalitions of other features in a consis- tent way, such that there is no possibility for missing combinatorial eﬀects of diﬀerent features changing the model outputs.Thus, the SHAP value method evaluates how each feature impacts the eﬀects of the other features on the model output. In the sup- plementary material, we provide more information on the SHAP-value method. For a detailed intro- duction, the reader is referred to the original work by Lundberg et al. (2020). SHAP-values provide local information for each element of the data set. A global measure of the importance of each feature can be obtained by tak- ing the average of the absolute values: FIi = ∑ t∈χtest |ϕi(y(t); f )| (7) Here, FIi is the feature importance of the i-th input feature, |·| denotes the absolute value operator, and χtest is the test set. Notably, SHAP-values do not inform on the quality of the prediction itself. For a detailed introduction to SHAP-values and XAI, the reader is referred to Lundberg et al. (2020) and to 0 1 2 3 4 5 6 Average absolute SHAP value DA DA DA + cos(t) sin(t) ID 00 3 (t 1h) ID 15 3 (t 1h) ID 30 3 (t 1h) ID 45 3 (t 1h) ID 00 3 (t 2h) ID 15 3 (t 2h) ID 30 3 (t 2h) ID 45 3 (t 2h) ID 00 3 (t) ID 15 3 (t) ID 30 3 (t) ID 45 3 (t) Fig. 5. SHAP-values (Lundberg et al., 2020) of the price diﬀerence vector for the price and time fea- tures. DA: day-ahead price, ∆DA +/−: day-ahead increments ahead and back, sin(t)/cos(t): trigone- metric hour encodings, and ∆IDXX 3 : price diﬀer- ence at given hour and 15 min interval. Kruse et al. (2021) for an example application to power grid frequencies. The SHAP value concept is designed for deter- ministic regression models. Thus, SHAP-values cannot be computed for the probabilistic models in Section 3. Instead, this work uses a tree regres- sor model, which is a popular choice to compute SHAP-values (Lundberg et al., 2020). In particu- lar, gradient boosted trees have been shown to oﬀer high levels of interpretability (Lundberg et al., 2020; Kruse et al., 2021). The gradient boosted trees are trained on 80% of the days from 2018 and 2019 and the remaining 20% of days are set aside as a test set. The test set is then used to score the accuracy of the trained models and to compute the SHAP- values. As SHAP-values can only be computed for scalar regressors, each of the four dimensions of the price diﬀerence vector is considered separately. For the SHAP-value analysis, this work uses the ‘SHAP’ library (Lundberg and Lee, 2017) and the gradi- ent boosted tree implementation in the machine- learning library scikit-learn (Pedregosa et al., 2011). For the test set, the regressor returns R2 of 74%, 60%, 61%, and 63% for each of the four price dif- ferences, respectively. 9 Page 10 of 20 0 1 2 3 4 5 6 Average absolute SHAP value Solar Error 00 Solar Error 15 Solar Error 30 Solar Error 45 Wind Error 00 Wind Error 15 Wind Error 30 Wind Error 45 Load Error 00 Load Error 15 Load Error 30 Load Error 45 ID 00 3 (t) ID 15 3 (t) ID 30 3 (t) ID 45 3 (t) Fig. 6. SHAP-values (Lundberg et al., 2020) of the price diﬀerence vector for the forecast error fea- tures. Solar, Wind, and Load: forecast errors at given hour and 15 min interval. 0 1 2 3 4 5 6 Average absolute SHAP value DA solar ramp DA wind ramp DA load ramp DA total gen ramp DA import/export ramp Oil price Gas price ID 00 3 (t) ID 15 3 (t) ID 30 3 (t) ID 45 3 (t) Fig. 7. SHAP-values (Lundberg et al., 2020) of the price diﬀerence vector for the day-ahead ramp- ing features. Day-ahead ramps for solar, wind, load, total power generation, and import and export bal- ances. The SHAP-values are computed using a single regressor for all input features. Figure 5, Figure 6, and Figure 7 show the feature importance deﬁned in Equation (7) for price and time features, the fore- cast error features, and the ramping features, re- spectively. The SHAP-values imply that there are few highly impactful features and many negligible features. In particular, the realizations of the price diﬀerence vector in the previous hour and the day- ahead increments show the most signiﬁcant impact. The previous hour shows the highest SHAP-values for the same 15 min interval, respectively. Mean- while, the absolute day-ahead price, the trigono- metric time encoding, the fossil fuel prices, and the second to last price diﬀerence vector realizations also show negligible impact. Of the forecast er- rors, only the renewables forecast errors in the last 15 minute interval show considerable impact. Note that using hour-ahead forecasts may change the fea- ture importance for the forecast errors. However, the small diﬀerence between the hour-ahead fore- casts and the realizations combined with the low feature importance of the proxy indicate that con- sidering the hour-ahead forecast is unlikely to cause signiﬁcant changes. The ramping features mostly impact the ﬁrst and the fourth interval in the price diﬀerence vector. Thus, the ramps mostly impact the orientation of the increasing or decreasing pat- tern in the data. Notably, the overall impact of the ramping features is minor. In summary, the SHAP-value analysis indicates that the day-ahead increments and the realization of the previous hour are the most informative as in- put features to the models in Section 3. The analy- sis further suggests that the performance of models trained to predict the price diﬀerence is indepen- dent of most external impact factors. For instance, oil and gas prices have negligible feature importance for the price diﬀerences. Intraday trading decisions are made in situations of immediate requirement rather than a planning situation. Thus, the diﬀer- ences to the day-ahead prices are not aﬀected by fuel prices. Still, electricity markets are continu- ously evolving, and the SHAP results in this study do not necessarily translate to other times. For an analysis of the Pearson correlation of the impact features, see the supplementary material of this work. 5 Numerical experiments This Section applies the diﬀerent probabilistic mod- eling approaches to predict the price diﬀerence vec- 10 5.1 Prediction intervals Page 11 of 20 tor distribution. Each model is trained on the data set from January 2018 to June 2019 (Fraunhofer- Institut für Solare Energiesysteme ISE, 2022), and the month of July 2019 is used as a test set. The 24 h × 31-day test set results in 744 test inter- vals. Note that July 1st, 2019, was a Monday. To preprocess the data and avoid complications from the heavy-tailed distributions (Han et al., 2022), the data is transformed using the probability inte- gral transform discussed in Uniejewski et al. (2017), which renders the data in a Gaussian form. The normalizing ﬂow and the Gaussian regression are trained via log-likelihood maximization over 500 epochs with a batch size of 128 using the python- based machine-learning library TensorFlow version 2.8.0 (Abadi and Agarwal, 2015). The Gaussian copula uses the quantile regression in the ‘statsmod- els’ python library (Seabold and Perktold, 2010). For details on the implementation of the models, see the supplementary material. One hundred sam- ples are drawn for each hour in the test set and used to compute the diﬀerent metrics outlined in Section 2. Sections 5.1 and 5.2 use the full set of input features derived in Section 4.1. Section 5.3 performs an empirical investigation of the impact of the diﬀerent groups of input features. 5.1 Prediction intervals This Section analyzes the forecasted distributions by investigating the 50% and 90% prediction inter- vals. The intervals are estimated by computing the respective quantiles of the drawn samples for each time step and then adding the day-ahead price of the given hour to reverse the diﬀerence in Equa- tion (1). Figure 8 shows the predicted mean, the 50%, and 90% prediction intervals, and the intraday price re- alization for the ﬁrst four days in the test month of July 2019. The Figure shows the results esti- mated from probabilistic forecasts from the nor- malizing ﬂow (top), the selection of historical data (second from top), the Gaussian copula (third from top), and the Gaussian regression (bottom). For the presented test days, the normalizing ﬂow pre- diction intervals enclose the realizations for most of the time steps, and the forecasted mean iden- tiﬁes the realized trends well, with very few ex- ceptions. The selection of historical data reﬂects the trends moderately well and portrays wider pre- diction intervals compared to the normalizing ﬂow. The Gaussian copula and the Gaussian regression often fail to identify the correct trends and do not ﬁt the realizations as tightly as the normalizing ﬂow. Tab. 5. Percentage of realizations within 50% and 90% prediction intervals (PI). PI 50% PI 90% Normalizing Flow 59.4% 93.5% Historical 62.1% 95.5% Copula 61.6% 96.0% Gaussian 54.9% 90.2% In particular, the Gaussian copula results in exten- sive prediction intervals that show vast peaks for the 90% prediction interval. Compared to the other approaches, the normalizing ﬂow performs signiﬁ- cantly better in identifying the trends and keeping narrow prediction intervals. Overall, the normal- izing ﬂow yields the sharpest prediction intervals, while the Gaussian copula shows low sharpness. On the ﬁrst day shown in Figure 8, there is a sig- niﬁcant peak in the ID3 price realization. This type of extreme event may occur due to unforeseen inci- dences in the markets, such as unplanned changes in the operation of large consumers or suppliers. Notably, the normalizing ﬂow is the only approach that captures this peak. The supplementary ma- terial shows the prediction intervals for other peak days in the test month that conﬁrm the normalizing ﬂows’ ability to capture the price peaks. Table 5 shows the percentage of time steps in the test set that lie within the 50% and 90% prediction interval, respectively. All approaches show conser- vative results for both prediction intervals, i.e., the actual percentage of realizations within the predic- tion intervals is higher than the selected probabil- ity. Thus, all approaches yield reliable prediction intervals. The supplementary material also lists the percentage of realizations within the prediction in- tervals for each of the four time steps of the price diﬀerence vector. The results show that the multi- variate approach is able to predict all four dimen- sions well and that there is no deterioration of the prediction accuracy for the later time steps. In summary, the normalizing ﬂow shows the best results with sharp prediction interval presented in Figure 8 and reliable results in Table 5. The se- lection of historical data shows surprisingly good results but has poor sharpness in the prediction in- tervals due to the missing conditional input infor- mation. The Gaussian copula results in prediction intervals with poor sharpness and extreme peaks that are likely a result of a poor quantile regres- sion of the tails of the price diﬀerence distribution. By overestimating the tails in the inverse CDF, the 11 5.1 Prediction intervals Page 12 of 20 07-01 00 07-01 12 07-02 00 07-02 12 07-03 00 07-03 12 07-04 00 07-04 12 07-05 00 0 20 40 60 80 100 120Intraday ID3 [EUR/MWh] Normalizing Flow mean realization 90% 50% 07-01 00 07-01 12 07-02 00 07-02 12 07-03 00 07-03 12 07-04 00 07-04 12 07-05 00 0 20 40 60 80 100 120Intraday ID3 [EUR/MWh] Historical mean realization 90% 50% 07-01 00 07-01 12 07-02 00 07-02 12 07-03 00 07-03 12 07-04 00 07-04 12 07-05 00 0 20 40 60 80 100 120Intraday ID3 [EUR/MWh] Copula mean realization 90% 50% 07-01 00 07-01 12 07-02 00 07-02 12 07-03 00 07-03 12 07-04 00 07-04 12 07-05 00 0 20 40 60 80 100 120Intraday ID3 [EUR/MWh] Gaussian mean realization 90% 50% Fig. 8. Comparison of probabilistic forecasts by the normalizing ﬂow, the informed selection of historical data, The Gaussian copula, and the Gaussian regression model to the actual realization (black line) for the ﬁrst ﬁve days in July 2019. The probabilistic forecasts are visualized in terms of the median (red line) and the 90% and 50% quantiles (shaded areas), respectively. Note the truncated y-axis for the Gaussian copula. Training data from January 2018 to June 2019 (Fraunhofer-Institut für Solare Energiesysteme ISE, 2022). Results generated with all conditional inputs derived in Section 4.1. 12 5.2 Energy and variogram score Page 13 of 20 Gaussian copula samples a higher share of outliers than the actual distribution. The high reliability in- dicated in Table 5 comes at the cost of poor sharp- ness. Finally, the Gaussian regression predicts 14 values for the mean vector and a lower-triangular covariance matrix (Dillon et al., 2017). Likely, this number is too high to achieve good ﬁts in the re- gression model, and instead, the training regresses to constant outputs. 5.2 Energy and variogram score Figure 9 shows the energy score for each model and each hour of the test month (left), as well as box plots of the overall energy score distributions (right). The Gaussian regression performs only marginally better than the historical selection. As shown in Figure 8, the Gaussian regression strug- gles to identify the correct trends, and the histor- ical selection shows wider prediction intervals, i.e., both approaches show weaknesses that lead to an increase in the energy score in diﬀerent ways. The Gaussian copula shows signiﬁcantly worse results than the other forecasting models. As already ob- served in Figure 8, the Gaussian copula results in extensive prediction intervals and fails to identify the intraday price patterns. Thus, the large energy scores in Figure 9 conﬁrm the qualitative observa- tions from Figure 8. Finally, the normalizing ﬂow shows the lowest energy score, i.e., it provides the most reliable predictions while maintaining sharp prediction intervals with a diverse set of samples. In general, the energy scores over time in the case of all methods show rare incidences of extreme price peaks, e.g., on the ﬁrst day and at the beginning of the last quarter of the month. Notably, however, the normalizing ﬂow shows the best approximation of these extreme events, e.g., for the price peak on the ﬁrst day of the test month shown in Figure 8 and the other peak days shown in the supplementary material. Next, the variogram score is used to compare whether the diﬀerent models can identify the cor- relation between the dimensions. Figure 10 shows the variogram score for each model and each hour of the test month (left), as well as box plots of the overall distributions (right). Note that the y-axis of the right of Figure 10 is truncated to allow for bet- ter visualization of the distributions. Similar to the energy score results, the normalizing ﬂow shows the best results, while the Gaussian regression performs approximately equal to the historical selection. The Gaussian copula appears to miss large parts of the correlation and shows the worst variogram scores. The ﬂexibility of the normalizing ﬂow allowed the model to learn the correlation between the four time steps in the price diﬀerence vector better than any other considered approach. In particular, the days with extreme price peaks result in consistently low variogram scores for the normalizing ﬂow, while all other models result in spiking variogram scores. In the supplementary material, we show the evalua- tions of energy score and variogram score over a longer period from July to December 2019. The results conﬁrm the observations described here. In conclusion, the ﬂexibility of the normalizing ﬂow can describe the non-trivial distribution of the considered price diﬀerences, as highlighted by both the energy scores and the variogram scores for the test month. Furthermore, the combination with ex- ternal impact factors leads to a signiﬁcant improve- ment over the historical selection. Meanwhile, the Gaussian copula results in erroneous trends and in- ﬂated prediction intervals, and the Gaussian regres- sion shows no advantage compared to the selection of historical data. 5.3 Signiﬁcance of external factors Up to this point, it remains unclear which external features contribute to the performance of the nor- malizing ﬂow predictions. The SHAP-value analysis in Section 4.2 has provided ﬁrst insights, albeit for a diﬀerent deterministic prediction model. This Sub- section now compares the performance of the nor- malizing ﬂow using diﬀerent sets of input features. Figure 11 shows box plots of the energy score and variogram score distributions over the test month for samples generated using the normalizing ﬂow with the diﬀerent groups of input features in com- parison to the selection of historical data. Note the truncated y-axis to highlight the majority parts of the distributions. The energy score results conﬁrm the observa- tions from the SHAP-value analysis in Section 4.2. The combination of the previous realization of the price diﬀerence vector and the day-ahead incre- ments (“∆ID3(t-1h) & ∆DA”) results in the largest improvement. The forecast errors (“Forecast er- rors”) lead to a moderate improvement, while the ramping features (“Ramping”) only result in a mi- nor improvement of the energy score compared to the historical selection (“Historical”). Notably, the combination of all external factors (“All”) achieves an energy score marginally below the combination of the previous realization of the price diﬀerence vector and the day-ahead increments. The variogram score conﬁrms the observations 13 5.3 Signiﬁcance of external factors Page 14 of 20 0 100ESNormalizing Flow 0 100ESHistorical 0 100ESCopula 2019-07-01 2019-07-04 2019-07-07 2019-07-10 2019-07-13 2019-07-16 2019-07-19 2019-07-22 2019-07-25 2019-07-28 2019-07-31 Days 0 100ESGaussian Normalizing Flow Historical Copula Gaussian 0 20 40 60 80 100Energy Score Fig. 9. Energy score (Gneiting et al., 2008; Pinson and Girard, 2012) of the normalizing ﬂow (“Nor- malizing Flow”), the selection of historical data (“Historical”), the Gaussian copula (“Copula”), and the Gaussian regression (“Gaussian”) for each hour in test month of July 2019 (left) and box plot (Waskom, 2021) of the overall distribution for each model (right). Training data from January 2018 to June 2019 (Fraunhofer-Institut für Solare Energiesysteme ISE, 2022). Conditional inputs as derived in Section 4.1. 0 200VSNormalizing Flow 0 200VSHistorical 0 200VSCopula 2019-07-01 2019-07-04 2019-07-07 2019-07-10 2019-07-13 2019-07-16 2019-07-19 2019-07-22 2019-07-25 2019-07-28 2019-07-31 Days 0 200VSGaussian Normalizing Flow Historical Copula Gaussian 0 20 40 60 80 100Variogram Score Fig. 10. Variogram score (Scheuerer and Hamill, 2015) of the normalizing ﬂow (“Normalizing Flow”), the selection of historical data (“Historical”), the Gaussian copula (“Copula”), and the Gaussian regression (“Gaussian”) for each hour in test month of July 2019 (left) and box plot (Waskom, 2021) of the overall distribution for each model (right). Training data from January 2018 to June 2019 (Fraunhofer-Institut für Solare Energiesysteme ISE, 2022). Conditional inputs as derived in Section 4.1. 14 5.4 Discussion Page 15 of 20HistoricalRampingForecast errorsID3(t-1h) & DAAll 0 10 20 30 40 50Energy ScoreHistoricalRampingForecast errorsID3(t-1h) & DAAll 0 10 20 30 40 50Variogram Score Fig. 11. Energy score (Gneiting et al., 2008; Pinson and Girard, 2012) and variogram score (Scheuerer and Hamill, 2015) of normalizing ﬂow predictions using diﬀerent sets of external factors. Note the truncated y-axis. Training data from Jan- uary 2018 to June 2019 (Fraunhofer-Institut für So- lare Energiesysteme ISE, 2022) and July 2019 as the test set. from the energy score. Except for the combination of all external factors (“All”) and the combination of the previous realization of the price diﬀerence vec- tor and the day-ahead increments (“∆ID3(t-1h) & ∆DA”), all inputs lead to approximately equal re- sults compared to the informed historical selection. In conclusion, the combination of the previous re- alization of the price diﬀerence vector and the day- ahead increments has by far the strongest impact on the performance of the probabilistic forecasts and appears to be suﬃcient to achieve high-quality prediction results. However, the normalizing ﬂow can still extract additional information from the re- maining external factors. Narajewski and Ziel (2020a) and Han et al. (2022) argue that the intraday markets are not eﬃcient in the sense of the eﬃcient-market hypothesis as there are strong relations between the current and previ- ous realizations. The results of this work conﬁrm this observation. 5.4 Discussion The analysis in this Section shows promising re- sults that indicate valuable density forecasts of the price diﬀerence vector by the normalizing ﬂow us- ing appropriate external input features. Both the Gaussian copula and the Gaussian regression show weaknesses and fail to improve on the results of the informed historical selection suggesting they are not suitable prediction methods. Figure 11 shows that only the knowledge of the realizations in the pre- vious hour and the day-ahead increments oﬀers a signiﬁcant advantage over using the informed selec- tion of historical data. Hence, lead times of mul- tiple hours rescind the advantage of the normaliz- ing ﬂow over the informed historical selection. In conclusion, the normalizing ﬂow yields high-quality density forecasts for short lead times. If the avail- able information is limited, the selection of histor- ical price diﬀerences based on the hour of the day appears to be suﬃcient. 6 Conclusion This work proposes a modeling approach for proba- bilistic forecasting of intraday electricity prices in the German EPEX spot market. The novel ap- proach captures the strong relation between day- ahead and intraday prices by assuming ﬁxed day- ahead prices and predicting the diﬀerence between the two price time series. Furthermore, the model captures the hourly patterns of ﬂuctuation of the intraday prices around the day-ahead prices by con- sidering each day-ahead trading interval as a four- dimensional joint distribution. Normalizing ﬂow, a non-parametric distribu- tion model, is used to learn the proposed four- dimensional distribution of price diﬀerences and in- cludes external input factors to form a conditional density forecast. The proposed model yields a com- plete end-to-end approach for multivariate density estimation and probabilistic regression that does not require any a priori assumptions about the data. Compared to a selection of historical data and other multivariate probabilistic models, namely the Gaussian copula and multivariate Gaussian regres- sion, the normalizing ﬂow returns the most reliable and sharpest predictions. Using methods from XAI and careful performance analysis, the role of diﬀer- ent input features has been analyzed in detail. In summary, the normalizing ﬂow best identiﬁes the trends of the intraday prices and shows the narrow- est prediction intervals. Declaration of Competing Inter- est We have no conﬂict of interest. 15 Page 16 of 20 Acknowledgements We gratefully acknowledge Johannes Kruse (FZ- Jülich IEK-STE), Julius Trebbien (FZ-Jülich IEK- STE), and Leonard Rydin Gorjão (Department of Computer Science, OsloMet) for the discussion about the concepts of explainable AI and the im- portance of diﬀerent impact factors. This work was performed as part of the Helmholtz School for Data Science in Life, Earth and Energy (HDS-LEE) and received funding from the Helmholtz Association of German Research Centres. Nomenclature Symbol Description f (y) Deterministic forecast- ing model FI Feature importance N Number of samples P RE t Power values RE ∈ {Solar, Wind, Load} ˆP RE t Forecast of renewable electricity ∆P RE t Forecast error of re- newable electricity T Invertible neural net- work JT −1 Jacobian of T −1 ˆT Day-ahead trading in- terval ˆT = 4 xt Value at time step t ˆxt Sample at time step t x, y Data vector ˆz Gaussian sample ˆx, ˆy Sample of data vector y External input factors ID3 Intraday price ID00 3 , ID15 3 , ID30 3 , ID45 3 Quater hour steps of intraday prices DA Day-ahead price ∆ID3 4D vector of price dif- ference φ Multivariate standard Gaussian ϕ SHAP value NX|Y (x; µX (y), ΣX (y)) Conditional Gaussian distribution pX|Y (x|y) Conditional PDF of X given Y p∆ID3|Y (∆ID3|y) Conditional PDF of ∆ID3 given Y NX|Y Gaussian distribu- tion with moments predicted via inputs Y µX (y) Neural network mean value predictor ΣX (y) Neural network covari- ance matrix value pre- dictor γ Variogram order (typi- cally γ = 0.5) 16 BIBLIOGRAPHY Page 17 of 20 Bibliography Abadi, M. and Agarwal, A. (2015). TensorFlow: Large-scale machine learning on heterogeneous systems. https://www.tensorflow.org/. Ac- cessed on 08-08-2021. Alova, G., Trotter, P. A., and Money, A. (2021). A machine-learning approach to predicting Africa’s electricity mix based on planned power plants and their chances of success. Nature Energy, 6(2):158– 166. Andrade, J. R., Filipe, J., Reis, M., and Bessa, R. J. (2017). Probabilistic price forecasting for day- ahead and intraday markets: Beyond the statis- tical model. Sustainability, 9(11):1990. Arpogaus, M., Voß, M., Sick, B., Nigge-Uricher, M., and Dürr, O. (2021). Probabilistic short-term low-voltage load forecasting using bernstein- polynomial normalizing ﬂows. In ICML 2021 Workshop on Tackling Climate Change with Ma- chine Learning, virtual. Badesa, L., Strbac, G., Magill, M., and Stojkovska, B. (2021). Ancillary services in Great Britain dur- ing the COVID-19 lockdown: A glimpse of the carbon-free future. Applied Energy, 285:116500. Bublitz, A., Keles, D., Zimmermann, F., Fraunholz, C., and Fichtner, W. (2019). A survey on electric- ity market design: Insights from theory and real- world implementations of capacity remuneration mechanisms. Energy Economics, 80:1059–1078. Cramer, E., Mitsos, A., Tempone, R., and Dah- men, M. (2022a). Principal component density estimation for scenario generation using normal- izing ﬂows. Data-Centric Engineering, 3:e7. Cramer, E., Paeleke, L., Mitsos, A., and Dahmen, M. (2022b). Normalizing ﬂow-based day-ahead wind power scenario generation for proﬁtable and reliable delivery commitments by wind farm op- erators. Computers & Chemical Engineering, 166:107923. Dillon, J. V., Langmore, I., Tran, D., Brevdo, E., Vasudevan, S., Moore, D., Patton, B., Alemi, A., Hoﬀman, M., and Saurous, R. A. (2017). Tensorﬂow distributions. arXiv preprint arXiv:1711.10604. Dinh, L., Sohl-Dickstein, J., and Bengio, S. (2017). Density estimation using Real NVP. In 5th In- ternational Conference on Learning Representa- tions, ICLR 2017, Toulon, France, April 24- 26, 2017, Conference Track Proceedings. Open- Review.net. Dumas, J., Wehenkel, A., Lanaspeze, D., Cornélusse, B., and Sutera, A. (2022). A deep generative model for probabilistic energy fore- casting in power systems: Normalizing ﬂows. Ap- plied Energy, 305:117871. ENTSO-E Transparency Platform (2022). ENTSO-E Transparency Platform. https: //transparency.entsoe.eu/. Accessed: 2022- 03-01. European Power Exchange (2021). EPEX SPOT documentation. http://www.epexspot.com/en/ extras/download-center/documentation. Ac- cessed: 2021-05-30. European Power Exchange (EPEX SPOT) (2020). Annual report 2019. https://www.epexspot. com/sites/default/files/download_center_ files/Epex-spot-2019_200703_Planche.pdf. Accessed: 2021-05-30. Fraunhofer-Institut für Solare Energiesysteme ISE (2022). Energy Charts. https://www. energy-charts.info. Accessed: 2022-03-01. Gneiting, T. and Raftery, A. E. (2007). Strictly proper scoring rules, prediction, and estimation. Journal of the American Statistical Association, 102(477):359–378. Gneiting, T., Stanberry, L. I., Grimit, E. P., Held, L., and Johnson, N. A. (2008). Assessing proba- bilistic forecasts of multivariate quantities, with an application to ensemble predictions of surface winds. Test, 17(2):211–235. Gunning, D. (2017). Explainable artiﬁcial intelli- gence (xai). Defense advanced research projects agency (DARPA), and Web, 2(2):1. Gürtler, M. and Paulsen, T. (2018). The eﬀect of wind and solar power forecasts on day-ahead and intraday electricity prices in Germany. Energy Economics, 75:150–162. Han, C., Hilger, H., Mix, E., Böttcher, P. C., Rey- ers, M., Beck, C., Witthaut, D., and Gorjão, L. R. (2022). Complexity and persistence of price time series of the european electricity spot mar- ket. PRX Energy, 1(1):013002. 17 BIBLIOGRAPHY Page 18 of 20 Huurman, C., Ravazzolo, F., and Zhou, C. (2012). The power of weather. Computational Statistics & Data Analysis, 56(11):3793–3807. Jedrzejewski, A., Lago, J., Marcjasz, G., and Weron, R. (2022a). Electricity price forecasting: The dawn of machine learning. IEEE Power and Energy Magazine, 20(3):24–31. Jedrzejewski, A., Lago, J., Marcjasz, G., and Weron, R. (2022b). Electricity price forecasting: The dawn of machine learning. IEEE Power and Energy Magazine, 20(3):24–31. Jónsson, T., Pinson, P., Madsen, H., and Nielsen, H. A. (2014). Predictive densities for day-ahead electricity prices using time-adaptive quantile re- gression. Energies, 7(9):5523–5547. Kiesel, R. and Paraschiv, F. (2017). Econometric analysis of 15-minute intraday electricity prices. Energy Economics, 64:77–90. Koch, C. and Hirth, L. (2019). Short-term electric- ity trading for system balancing: An empirical analysis of the role of intraday trading in balanc- ing germany’s electricity system. Renewable and Sustainable Energy Reviews, 113:109275. Kremer, M., Kiesel, R., and Paraschiv, F. (2021). An econometric model for intraday electricity trading. Philosophical Transactions of the Royal Society A, 379(2202):20190624. Kruse, J., Schäfer, B., and Witthaut, D. (2020). Predictability of power grid frequency. IEEE Ac- cess, 8:149435–149446. Kruse, J., Schäfer, B., and Witthaut, D. (2021). Revealing drivers and risks for power grid fre- quency stability with explainable AI. Patterns, 2(11):100365. Kulakov, S. and Ziel, F. (2019). The impact of re- newable energy forecasts on intraday electricity prices. arXiv preprint arXiv:1903.09641. Kuzlu, M., Cali, U., Sharma, V., and Güler, Ö. (2020). Gaining insight into solar photovoltaic power generation forecasting utilizing explain- able artiﬁcial intelligence tools. IEEE Access, 8:187814–187823. Lago, J., Marcjasz, G., De Schutter, B., and Weron, R. (2021). Forecasting day-ahead elec- tricity prices: A review of state-of-the-art algo- rithms, best practices and an open-access bench- mark. Applied Energy, 293:116983. Lundberg, S. M., Erion, G., Chen, H., DeGrave, A., Prutkin, J. M., Nair, B., Katz, R., Himmel- farb, J., Bansal, N., and Lee, S.-I. (2020). From local explanations to global understanding with explainable AI for trees. Nature machine intelli- gence, 2(1):56–67. Lundberg, S. M. and Lee, S.-I. (2017). A uniﬁed approach to interpreting model predictions. In Guyon, I., Luxburg, U. V., Bengio, S., Wallach, H., Fergus, R., Vishwanathan, S., and Garnett, R., editors, Advances in Neural Information Pro- cessing Systems 30, pages 4765–4774. Curran As- sociates, Inc. Marcjasz, G., Uniejewski, B., and Weron, R. (2020). Probabilistic electricity price forecasting with narx networks: Combine point or probabilistic forecasts? International Journal of Forecasting, 36(2):466–479. Mayer, K. and Trück, S. (2018). Electricity mar- kets around the world. Journal of Commodity Markets, 9:77–100. Michał Narajewski, F. Z. (2020). Changes in elec- tricity demand pattern in europe due to COVID- 19 shutdowns. IAEE Energy Forum, pages 44–47. Moon, J., Park, S., Rho, S., and Hwang, E. (2019). A comparative analysis of arti- ﬁcial neural network architectures for build- ing energy consumption forecasting. Interna- tional Journal of Distributed Sensor Networks, 15(9):1550147719877616. Narajewski, M. and Ziel, F. (2020a). Economet- ric modelling and forecasting of intraday elec- tricity prices. Journal of Commodity Markets, 19:100107. Narajewski, M. and Ziel, F. (2020b). Ensemble fore- casting for intraday electricity prices: Simulating trajectories. Applied Energy, 279:115801. Nowotarski, J. and Weron, R. (2018). Recent ad- vances in electricity price forecasting: A review of probabilistic forecasting. Renewable and Sus- tainable Energy Reviews, 81:1548–1568. Ocker, F. and Ehrhart, K.-M. (2017). The “German Paradox” in the balancing power markets. Re- newable and Sustainable Energy Reviews, 67:892– 898. Panagiotelis, A. and Smith, M. (2008). Bayesian density forecasting of intraday electricity prices 18 BIBLIOGRAPHY Page 19 of 20 using multivariate skew t distributions. Interna- tional Journal of Forecasting, 24(4):710–727. Papamakarios, G., Nalisnick, E., Rezende, D. J., Mohamed, S., and Lakshminarayanan, B. (2021). Normalizing ﬂows for probabilistic modeling and inference. Journal of Machine Learning Research, 22(57):1–64. Pape, C., Hagemann, S., and Weber, C. (2016). Are fundamentals enough? explaining price vari- ations in the german day-ahead and intraday power market. Energy Economics, 54:376–387. Pedregosa, F., Varoquaux, G., Gramfort, A., Michel, V., Thirion, B., Grisel, O., Blondel, M., Prettenhofer, P., Weiss, R., Dubourg, V., Van- derplas, J., Passos, A., Cournapeau, D., Brucher, M., Perrot, M., and Duchesnay, E. (2011). Scikit- learn: Machine learning in Python. Journal of Machine Learning Research, 12:2825–2830. Pinson, P. and Girard, R. (2012). Evaluating the quality of scenarios of short-term wind power gen- eration. Applied Energy, 96:12–20. Pinson, P., Madsen, H., Nielsen, H. A., Pa- paefthymiou, G., and Klöckl, B. (2009). From probabilistic forecasts to statistical scenarios of short-term wind power production. Wind En- ergy: An International Journal for Progress and Applications in Wind Power Conversion Technol- ogy, 12(1):51–62. Rasul, K., Sheikh, A.-S., Schuster, I., Bergmann, U. M., and Vollgraf, R. (2021). Multivariate prob- abilistic time series forecasting via conditioned normalizing ﬂows. In International Conference on Learning Representations. Scheuerer, M. and Hamill, T. M. (2015). Variogram- based proper scoring rules for probabilistic fore- casts of multivariate quantities. Monthly Weather Review, 143(4):1321–1334. Seabold, S. and Perktold, J. (2010). Statsmod- els: Econometric and statistical modeling with python. In Proceedings of the 9th Python in Sci- ence Conference, pages 92–96, Austin, TX. Sensfuß, F., Ragwitz, M., and Genoese, M. (2008). The merit-order eﬀect: A detailed analysis of the price eﬀect of renewable electricity generation on spot market prices in germany. Energy policy, 36(8):3086–3094. Seraﬁn, T., Marcjasz, G., and Weron, R. (2022). Trading on short-term path forecasts of intraday electricity prices. Energy Economics, 112:106125. Serinaldi, F. (2011). Distributional modeling and short-term forecasting of electricity prices by gen- eralized additive models for location, scale and shape. Energy Economics, 33(6):1216–1226. Shinde, P. and Amelin, M. (2019). A literature re- view of intraday electricity markets and prices. In 2019 IEEE Milan PowerTech, pages 1–6. Spodniak, P., Ollikka, K., and Honkapuro, S. (2021). The impact of wind power and electricity demand on the relevance of diﬀerent short-term electricity markets: The nordic case. Applied En- ergy, 283:116063. Sweeney, C., Bessa, R. J., Browell, J., and Pinson, P. (2020). The future of forecasting for renewable energy. Wiley Interdisciplinary Reviews: Energy and Environment, 9(2):e365. Tjoa, E. and Guan, C. (2020). A survey on explain- able artiﬁcial intelligence (XAI): Toward medical XAI. IEEE Transactions on Neural networks and Learning Systems, 32(11):4793–4813. Trebbien, J., Gorjão, L. R., Praktiknjo, A., Schäfer, B., and Witthaut, D. (2022). Understand- ing electricity prices beyond the merit order principle using explainable ai. arXiv preprint arXiv:2212.04805. Uniejewski, B. and Weron, R. (2021). Regular- ized quantile regression averaging for probabilis- tic electricity price forecasting. Energy Eco- nomics, 95:105121. Uniejewski, B., Weron, R., and Ziel, F. (2017). Variance stabilizing transformations for electric- ity spot price forecasting. IEEE Transactions on Power Systems, 33(2):2219–2229. Viehmann, J. (2017). State of the German short-term power market. Zeitschrift für En- ergiewirtschaft, 41(2):87–103. Waskom, M. L. (2021). Seaborn: statistical data visualization. Journal of Open Source Software, 6(60):3021. Weron, R. (2014). Electricity price forecasting: A review of the state-of-the-art with a look into the future. International Journal of Forecasting, 30(4):1030–1081. 19 BIBLIOGRAPHY Page 20 of 20 Winkler, C., Worrall, D., Hoogeboom, E., and Welling, M. (2019). Learning likelihoods with conditional normalizing ﬂows. arXiv preprint arXiv:1912.00042. Wolﬀ, G. and Feuerriegel, S. (2017). Short-term dynamics of day-ahead and intraday electricity prices. International Journal of Energy Sector Management, 11:557–573. Zhang, L., Luh, P. B., and Kasiviswanathan, K. (2003). Energy clearing price prediction and con- ﬁdence interval estimation with cascaded neural networks. IEEE Transactions on Power Systems, 18(1):99–105. Ziel, F. and Weron, R. (2018). Day-ahead elec- tricity price forecasting with high-dimensional structures: Univariate vs. multivariate modeling frameworks. Energy Economics, 70:396–420. 20 Page 1 of 8 Multivariate Probabilistic Forecasting of Intraday Electricity Prices using Normalizing Flows Eike Cramer a,b , Dirk Witthaut c,d , Alexander Mitsos e,a,b , Manuel Dahmena,∗ a Forschungszentrum Jülich GmbH, Institute of Energy and Climate Research, Energy Systems Engineering (IEK-10), Jülich 52425, Germany b RWTH Aachen University, Process Systems Engineering (AVT.SVT), Aachen 52074, Germany c Forschungszentrum Jülich GmbH, Institute of Energy and Climate Research, Systems Analysis and Technology Evaluation (IEK-STE), Jülich 52428, Germany d Institute for Theoretical Physics, University of Cologne, 50937 Köln, Germany e JARA-ENERGY, Jülich 52425, Germany 1 Input feature selection Table 1, Table 2, and Table 3 list the Pearson cor- relation of all considered external factors with the 4 dimensions of the price diﬀerence vector ∆ID3. The Pearson correlation indicates the highest de- pendency on the immediate history of the price dif- ference vector. 2 Time dependency Figures 1 shows the dependency of the price dif- ference vector on the hour of the day, the day of the week, and the month of the year, respectively. Notably, only the hour of the day appears to have a signiﬁcant impact on the realizations. This also indicates a similar behavior of the price diﬀerences for weekdays and weekends. 3 Shapley Additive exPlana- tions For black-box machine learning models, the quan- titative relationship between input features and model outputs is often unknown. Here, explain- able artiﬁcial intelligence (XAI) oﬀers methods to estimate the quantitative relationship between fea- tures and outputs. A simple approach estimates the impact of diﬀerent features using variations under the ceteris paribus assumption, i.e., by varying a single feature while keeping the remaining features constant. However, such one-at-a-time variations ignore possible combinatorial eﬀects, which often lead to nonlinear behavior in the outputs. Shapley Additive exPlanations (SHAP) values are designed to describe the impacts of the input features on the model output including nonlinear combinato- rial eﬀects (Lundberg and Lee, 2017). Thus, SHAP values give quantitative insight into the underlying systematic behavior of the system and can, e.g., be used to reveal the driving factors of a stochastic process like the power grid frequency (Kruse et al., 2021) or electricity prices (Trebbien et al., 2022). SHAP values are computed by combining the marginal feature perturbations, i.e., the impact of including or excluding the feature from the feature set, for all possible coalitions and combinations of features. Notably, this evaluation of all possible combinations is computationally prohibitively ex- pensive for large feature sets and arbitrary models. However, there exist eﬃcient algorithms that com- pute SHAP values for tree-based models in poly- nomial time (Lundberg and Lee, 2017; Lundberg et al., 2020). For more information on the com- putation of SHAP values, the reader is referred to the original publications (Lundberg and Lee, 2017; Lundberg et al., 2020) and the documentation of the SHAP python package (Lundberg and Lee, 2017). SHAP values are based on the idea to express a model output f (y) using an additive feature attri- bution (Lundberg et al., 2020): f (y) ≈ ϕ0 + ∑ i ϕi(yi; f ) (1) Here, ϕ0 is the null output, and ϕi(yi; f ) are the SHAP values for each input feature i. The null output is computed as the expected model output over the full dataset: ϕ0 = 1 N ∑ t f (yt) Here, N is the number of points in the dataset. For tree-based models, like the ones used for the SHAP analysis in the main paper, the SHAP algorithm provides exact local accuracy, i.e., the approxi- mate additive feature attribution in Equation (1) is met exactly. The formulation via the additive fea- ture attribution also ensures the missingness in the ∗Manuel Dahmen, Forschungszentrum Jülich GmbH, Institute of Energy and Climate Research, Energy Systems Engineering (IEK-10), Jülich 52425, Germany E-mail: m.dahmen@fz-juelich.dearXiv:2205.13826v4 [cs.LG] 10 Mar 2023 Page 2 of 8 Tab. 1. Pearson correlation between the price diﬀerence dimensions ∆ID3 and the price and time features. 00, . . . , 45 indicate the for 15 min intervals in each day-ahead trading interval. Price data from Fraunhofer-Institut für Solare Energiesysteme ISE (2022) and renewables data from ENTSO-E (ENTSO-E Transparency Platform, 2022). External factors ∆ID00 3 ∆ID15 3 ∆ID30 3 ∆ID45 3 DA -0.02 -0.04 -0.05 -0.04 ∆DA− -0.44 -0.16 0.14 0.31 ∆DA+ 0.38 0.10 -0.22 -0.43 cos(t) 0.11 0.03 -0.04 -0.10 sin(t) 0.01 0.00 0.02 -0.01 ∆ID00 3 (t − 1h) 0.72 0.55 0.28 0.05 ∆ID15 3 (t − 1h) 0.70 0.69 0.51 0.31 ∆ID30 3 (t − 1h) 0.49 0.67 0.69 0.56 ∆ID45 3 (t − 1h) 0.24 0.53 0.70 0.67 ∆ID00 3 (t − 2h) 0.46 0.37 0.22 0.09 ∆ID15 3 (t − 2h) 0.51 0.50 0.38 0.24 ∆ID30 3 (t − 2h) 0.44 0.52 0.48 0.36 ∆ID45 3 (t − 2h) 0.31 0.45 0.48 0.42 Tab. 2. Pearson correlation between the price diﬀerence dimensions ∆ID3 and the forecast errors. 00, . . . , 45 indicate the for 15 min intervals in each day-ahead trading interval. Price data from Fraunhofer- Institut für Solare Energiesysteme ISE (2022) and renewables data from ENTSO-E (ENTSO-E Trans- parency Platform, 2022). External factors ∆ID00 3 ∆ID15 3 ∆ID30 3 ∆ID45 3 Solar Error 00 -0.20 -0.23 -0.21 -0.15 Solar Error 15 -0.20 -0.24 -0.23 -0.17 Solar Error 30 -0.20 -0.24 -0.24 -0.18 Solar Error 45 -0.20 -0.24 -0.24 -0.19 Wind Error 00 -0.28 -0.36 -0.38 -0.32 Wind Error 15 -0.28 -0.36 -0.39 -0.33 Wind Error 30 -0.28 -0.37 -0.39 -0.33 Wind Error 45 -0.28 -0.36 -0.39 -0.34 Load Error 00 0.12 0.11 0.09 0.04 Load Error 15 0.12 0.11 0.09 0.04 Load Error 30 0.12 0.11 0.09 0.04 Load Error 45 0.12 0.11 0.08 0.03 2 Page 3 of 8 Tab. 3. Pearson correlation between the price diﬀerence dimensions ∆ID3 and the ramping features. 00, . . . , 45 indicate the for 15 min intervals in each day-ahead trading interval. Price data from Fraunhofer- Institut für Solare Energiesysteme ISE (2022) and renewables data from ENTSO-E (ENTSO-E Trans- parency Platform, 2022). External factors ∆ID00 3 ∆ID15 3 ∆ID30 3 ∆ID45 3 DA solar ramp 0.23 0.08 -0.07 -0.21 DA wind ramp 0.05 -0.03 -0.10 -0.14 DA load ramp -0.27 -0.09 0.12 0.25 DA total gen ramp -0.02 -0.01 0.03 -0.01 DA import/export ramp -0.27 -0.09 0.09 0.26 Oil price -0.01 0.01 0.01 0.00 Gas price -0.02 -0.01 -0.02 -0.03 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 Time [h] 30 20 10 0 10 20 30 ID3 ID 00 3 (t) ID 15 3 (t) ID 30 3 (t) ID 45 3 (t) Monday Tuesday Wednesday Thursday Friday Saturday Sunday 30 20 10 0 10 20 30 ID3 ID 00 3 (t) ID 15 3 (t) ID 30 3 (t) ID 45 3 (t) Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec 30 20 10 0 10 20 30 ID3 ID 00 3 (t) ID 15 3 (t) ID 30 3 (t) ID 45 3 (t) Fig. 1. Box plots of distribution of price diﬀerence as function of hour of the day, day of the week, and month of the year. 3 Page 4 of 8 model such that, if a SHAP value is zero, the model output does not change. Furthermore, the SHAP value decomposition is consistent, i.e., a change to an input feature leads to a change in the corre- sponding SHAP value (Lundberg and Lee, 2017). 4 Additional analysis of Win- kler score The Winkler score (Winkler, 1972; Gneiting and Raftery, 2007) is a well-established test to inves- tigate reliability and sharpness: WS =    δt xt ∈ [ ˆL α t , ˆU α t ] δt + 2 1−α ( ˆU α t − xt) xt ≥ ˆU α t δt + 2 1−α (xt − ˆL α t ) xt ≤ ˆL α t Here, xt is the time step, ˆL α t and ˆU α t are the lower and upper bound of the conﬁdence interval with probability α, respectively. The term δt indicates the width of the predicted conﬁdence interval: δt = ˆU α t − ˆL α t The Winkler score is a negatively oriented score, i.e., lower values indicate better performance. Figure 2 shows the distributions of Winkler scores over the full month of July 2019 for each of the probabilistic models and over α values between 0.0 and 0.9. Overall, the normalizing ﬂow shows the best results. 5 ANN structures The Gaussian regression uses a fully-connected neu- ral network with one hidden layer, 32 neurons, and ‘tanh’ activation. The output layer has 14 neu- rons to describe the four-dimensional mean and the lower triangular covariance matrix implemented in TensorFlow-probability (Dillon et al., 2017). The neuron that output the mean have no activation and the neurons that output the covariance matrix use ‘softmax’ activation to ensure strict positivity. The normalizing ﬂow uses the aﬃne coupling layer implementation in (Dinh et al., 2017). The full model uses four aﬃne coupling layers with fully con- nected conditioner models. The conditioner models have two hidden layers with ‘ReLU’ activation and four neurons per layer. Tab. 4. Percentage of realizations within 50% and 90% prediction intervals (PI) for each quarter hour. Results for normalizing ﬂow over test interval from July 1st, 2019 to December 31st, 2019. ∆ID00 3 ∆ID15 3 ∆ID30 3 ∆ID45 3 PI 50% 0.54 0.53 0.54 0.62 PI 90% 0.91 0.90 0.91 0.93 6 Prediction intervals on ex- treme peaks Figure 3 shows the predicted mean, the prediction intervals of 50% and 90%, and the realization be- tween July 21 st and July 26 th of 2019. Similar to the prediction intervals shown in the main part of the paper, the results conﬁrm that the normalizing ﬂow results in the narrowest prediction intervals and is the only approach that captures the extreme price peaks. 7 Quarter-hourly resolution of prediction interval accuracy Table 4 shows the share of realizations within the prediction intervals for each of the four dimensions of the distribution predicted by the normalizing ﬂow. The results show no deterioration of perfor- mance for the later time steps. Thus, any concern about limitations of the multivariate model being applied to the step-by-step realizing intraday price are theoretical rather than practical. 8 Energy and variagram score Figure 4 shows the energy score and Figure 5 shows the variogram score for each model and each hour from July to December 2019 (left), as well as box plots of the overall distributions (right). Note that there are some peaks in the results of all methods in both the energy score and the variogramm score, e.g., in September or December. Still, the distribu- tion of the values for energy score and variogram score for the extended test periods conﬁrm the ob- servations from the main paper. 4 BIBLIOGRAPHY Page 5 of 8 0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 alpha 0 20 40 60 80 100Winkler score Historical Normalizing Flow Copula Gaussian Fig. 2. Winkler score (Winkler, 1972; Gneiting and Raftery, 2007) over conﬁdenc interval width alpha for the diﬀerent models and the historical data. Training data from January 2018 to June 2019. Full distribution of scores over the test month of July 2019. Bibliography Dillon, J. V., Langmore, I., Tran, D., Brevdo, E., Vasudevan, S., Moore, D., Patton, B., Alemi, A., Hoﬀman, M., and Saurous, R. A. (2017). Tensorﬂow distributions. arXiv preprint arXiv:1711.10604. Dinh, L., Sohl-Dickstein, J., and Bengio, S. (2017). Density estimation using Real NVP. In 5th In- ternational Conference on Learning Representa- tions, ICLR 2017, Toulon, France, April 24- 26, 2017, Conference Track Proceedings. Open- Review.net. ENTSO-E Transparency Platform (2022). ENTSO-E Transparency Platform. https: //transparency.entsoe.eu/. Accessed: 2022- 03-01. Fraunhofer-Institut für Solare Energiesysteme ISE (2022). Energy Charts. https://www. energy-charts.info. Accessed: 2022-03-01. Gneiting, T. and Raftery, A. E. (2007). Strictly proper scoring rules, prediction, and estimation. Journal of the American Statistical Association, 102(477):359–378. Gneiting, T., Stanberry, L. I., Grimit, E. P., Held, L., and Johnson, N. A. (2008). Assessing proba- bilistic forecasts of multivariate quantities, with an application to ensemble predictions of surface winds. Test, 17(2):211–235. Kruse, J., Schäfer, B., and Witthaut, D. (2021). Revealing drivers and risks for power grid fre- quency stability with explainable AI. Patterns, 2(11):100365. Lundberg, S. M., Erion, G., Chen, H., DeGrave, A., Prutkin, J. M., Nair, B., Katz, R., Himmel- farb, J., Bansal, N., and Lee, S.-I. (2020). From local explanations to global understanding with explainable AI for trees. Nature machine intelli- gence, 2(1):56–67. Lundberg, S. M. and Lee, S.-I. (2017). A uni- ﬁed approach to interpreting model predictions. In Proceedings of the 31st International Confer- ence on Neural Information Processing Systems, NIPS’17, page 4768–4777, Red Hook, NY, USA. Curran Associates Inc. Pinson, P. and Girard, R. (2012). Evaluating the quality of scenarios of short-term wind power gen- eration. Applied Energy, 96:12–20. Scheuerer, M. and Hamill, T. M. (2015). Variogram- based proper scoring rules for probabilistic fore- casts of multivariate quantities. Monthly Weather Review, 143(4):1321–1334. Trebbien, J., Gorjão, L. R., Praktiknjo, A., Schäfer, B., and Witthaut, D. (2022). Understand- ing electricity prices beyond the merit order principle using explainable ai. arXiv preprint arXiv:2212.04805. 5 BIBLIOGRAPHY Page 6 of 8 2019-07-21 2019-07-22 2019-07-23 2019-07-24 2019-07-25 2019-07-26 0 50 100 150Intraday ID3 [EUR/MWh] Normalizing Flow mean realization 90% 50% 2019-07-21 2019-07-22 2019-07-23 2019-07-24 2019-07-25 2019-07-26 0 50 100 150Intraday ID3 [EUR/MWh] Historical mean realization 90% 50% 2019-07-21 2019-07-22 2019-07-23 2019-07-24 2019-07-25 2019-07-26 0 50 100 150Intraday ID3 [EUR/MWh] Copula mean realization 90% 50% 2019-07-21 2019-07-22 2019-07-23 2019-07-24 2019-07-25 2019-07-26 0 50 100 150Intraday ID3 [EUR/MWh] Gaussian mean realization 90% 50% Fig. 3. Predicted mean, prediction intervals of 50% and 90%, and realization between July 21 st and July 26 th of 2019 estimated from the probabilistic forecasts form the normalizing ﬂow (top), the selection of historical data (second from top), the Gaussian copula (third from top), and the Gaussian regression (bottom). Note the truncated y-axis for the Gaussian copula. Training data from January 2018 to June 2019 (Fraunhofer-Institut für Solare Energiesysteme ISE, 2022). Results generated with all conditional inputs. 6 BIBLIOGRAPHY Page 7 of 8 0 200ESNormalizing Flow 0 200ESHistorical 0 200ESCopula 2019-07-01 2019-07-19 2019-08-06 2019-08-24 2019-09-12 2019-09-30 2019-10-18 2019-11-06 2019-11-24 2019-12-12 2019-12-30 Days 0 200ESGaussian Normalizing Flow Historical Copula Gaussian 0 20 40 60 80 100Energy Score Fig. 4. Energy score (Gneiting et al., 2008; Pinson and Girard, 2012) of the normalizing ﬂow (“Nor- malizing Flow”), the selection of historical data (“Historical”), the Gaussian copula (“Copula”), and the Gaussian regression (“Gaussian”) for each hour from July to December 2019 (left) and box plot (Waskom, 2021) of the overall distribution for each model (right). Training data from January 2018 to June 2019 (Fraunhofer-Institut für Solare Energiesysteme ISE, 2022). 0 200VSNormalizing Flow 0 200VSHistorical 0 200VSCopula 2019-07-01 2019-07-19 2019-08-06 2019-08-24 2019-09-12 2019-09-30 2019-10-18 2019-11-06 2019-11-24 2019-12-12 2019-12-30 Days 0 200VSGaussian Normalizing Flow Historical Copula Gaussian 0 20 40 60 80 100Variogram Score Fig. 5. Variogram score (Scheuerer and Hamill, 2015) of the normalizing ﬂow (“Normalizing Flow”), the selection of historical data (“Historical”), the Gaussian copula (“Copula”), and the Gaussian regression (“Gaussian”) for each hour from July to December 2019 (left) and box plot (Waskom, 2021) of the overall distribution for each model (right). Training data from January 2018 to June 2019 (Fraunhofer-Institut für Solare Energiesysteme ISE, 2022). 7 BIBLIOGRAPHY Page 8 of 8 Waskom, M. L. (2021). Seaborn: statistical data visualization. Journal of Open Source Software, 6(60):3021. Winkler, R. L. (1972). A decision-theoretic ap- proach to interval estimation. Journal of the American Statistical Association, 67(337):187– 191. 8","libVersion":"0.3.2","langs":""}